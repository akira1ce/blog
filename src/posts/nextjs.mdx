---
title: Next.js
category: ["react", "framework"]
slug: nextjs
date: 2023-11-15
summary: æ·±å…¥æ¢ç´¢ Next.js çš„æ ¸å¿ƒæ¦‚å¿µä¸å®è·µ
---

# TODO

- [ ] [Composition Patterns](https://nextjs.org/docs/app/building-your-application/rendering/composition-patterns)

- [ ] [Partial Prerendering](https://nextjs.org/docs/app/building-your-application/rendering/partial-prerendering)

- [ ] [Caching](https://nextjs.org/docs/app/building-your-application/caching)

- [ ] [Package Bundling](https://nextjs.org/docs/app/building-your-application/optimizing/package-bundling)

- [ ] [Instrumentation](https://nextjs.org/docs/app/building-your-application/optimizing/instrumentation)

- [ ] [Analytics](https://nextjs.org/docs/app/building-your-application/optimizing/analytics)

- [ ] [Third Party Libraries](https://nextjs.org/docs/app/building-your-application/optimizing/third-party-libraries)

# SSR

## åŸç†

Server-Side Render

ä½¿ç”¨ SSR æ—¶ï¼Œéœ€è¦å®Œæˆä¸€ç³»åˆ—æ­¥éª¤ï¼Œç„¶åç”¨æˆ·æ‰èƒ½çœ‹åˆ°é¡µé¢å¹¶ä¸ä¹‹äº¤äº’ï¼š

1. é¦–å…ˆï¼Œåœ¨æœåŠ¡å™¨ä¸Šè·å–ç»™å®šé¡µé¢çš„æ‰€æœ‰æ•°æ®ã€‚
2. ç„¶åï¼ŒæœåŠ¡å™¨å‘ˆç°é¡µé¢çš„ HTMLã€‚
3. é¡µé¢çš„ HTMLã€CSS å’Œ JavaScript å°†å‘é€åˆ°å®¢æˆ·ç«¯ã€‚
4. éäº¤äº’å¼ç”¨æˆ·ç•Œé¢ä½¿ç”¨ç”Ÿæˆçš„ HTML å’Œ CSS æ˜¾ç¤ºã€‚
5. æœ€åï¼ŒReact [å¯¹ç”¨æˆ·ç•Œé¢è¿›è¡Œæ°´åˆ](https://react.dev/reference/react-dom/client/hydrateRoot#hydrating-server-rendered-html)ï¼Œä½¿å…¶å…·æœ‰äº¤äº’æ€§ã€‚

![alt text](assets/image-1.png)

> è¿™äº›æ­¥éª¤æ˜¯**è¿ç»­**çš„å’Œ**é˜»å¡**çš„ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨åªèƒ½åœ¨è·å–æ‰€æœ‰æ•°æ®åå‘ˆç°é¡µé¢çš„ HTMLã€‚è€Œä¸”ï¼Œåœ¨å®¢æˆ·ç«¯ä¸Šï¼ŒReact åªæœ‰åœ¨ä¸‹è½½äº†é¡µé¢ä¸­æ‰€æœ‰ç»„ä»¶çš„ä»£ç åæ‰èƒ½æ°´åˆ UIã€‚

## ä¼˜ç‚¹

1. **æ•°æ®è·å–**ï¼šæœåŠ¡å™¨ç»„ä»¶å…è®¸æ‚¨å°†æ•°æ®è·å–ç§»åŠ¨åˆ°æœåŠ¡å™¨ï¼Œé è¿‘æ‚¨çš„æ•°æ®æºã€‚è¿™å¯ä»¥é€šè¿‡å‡å°‘è·å–æ¸²æŸ“æ‰€éœ€æ•°æ®çš„æ—¶é—´å’Œå®¢æˆ·ç«¯éœ€è¦å‘å‡ºçš„è¯·æ±‚æ•°é‡æ¥æé«˜æ€§èƒ½ã€‚

2. **å®‰å…¨æ€§**: æœåŠ¡å™¨ç»„ä»¶å…è®¸æ‚¨å°†æ•æ„Ÿæ•°æ®å’Œé€»è¾‘ä¿å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œä¾‹å¦‚ä»¤ç‰Œå’Œ API å¯†é’¥ï¼Œè€Œä¸ä¼šå°†å…¶æš´éœ²ç»™å®¢æˆ·ç«¯ã€‚

3. **ç¼“å­˜**ï¼šé€šè¿‡åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“ï¼Œç»“æœå¯ä»¥è¢«ç¼“å­˜å¹¶åœ¨åç»­è¯·æ±‚å’Œç”¨æˆ·ä¹‹é—´é‡å¤ä½¿ç”¨ã€‚è¿™å¯ä»¥é€šè¿‡å‡å°‘æ¯ä¸ªè¯·æ±‚ä¸Šçš„æ¸²æŸ“å’Œæ•°æ®è·å–é‡æ¥æé«˜æ€§èƒ½å¹¶é™ä½æˆæœ¬ã€‚

4. **æ€§èƒ½**ï¼šæœåŠ¡å™¨ç»„ä»¶ä¸ºæ‚¨æä¾›äº†é¢å¤–çš„å·¥å…·ï¼Œä»¥ä¼˜åŒ–åŸºçº¿æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä»å®Œå…¨ç”±å®¢æˆ·ç«¯ç»„ä»¶ç»„æˆçš„åº”ç”¨ç¨‹åºå¼€å§‹ï¼Œå°† UI çš„éäº¤äº’å¼éƒ¨åˆ†ç§»åŠ¨åˆ°æœåŠ¡å™¨ç»„ä»¶å¯ä»¥å‡å°‘æ‰€éœ€çš„å®¢æˆ·ç«¯ JavaScript çš„æ•°é‡ã€‚å¯¹äºäº’è”ç½‘é€Ÿåº¦è¾ƒæ…¢æˆ–è®¾å¤‡æ€§èƒ½è¾ƒä½çš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™æ˜¯æœ‰ç›Šçš„ï¼Œå› ä¸ºæµè§ˆå™¨éœ€è¦ä¸‹è½½ã€è§£æå’Œæ‰§è¡Œçš„å®¢æˆ·ç«¯ JavaScript è¾ƒå°‘ã€‚

5. **åˆå§‹é¡µé¢åŠ è½½å’Œ[é¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼ˆFCPï¼‰](https://web.dev/fcp/)**ï¼šåœ¨æœåŠ¡å™¨ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆ HTMLï¼Œè®©ç”¨æˆ·ç«‹å³æŸ¥çœ‹é¡µé¢ï¼Œè€Œæ— éœ€ç­‰å¾…å®¢æˆ·ç«¯ä¸‹è½½ã€è§£æå’Œæ‰§è¡Œæ¸²æŸ“é¡µé¢æ‰€éœ€çš„ JavaScriptã€‚

6. **æœç´¢å¼•æ“ä¼˜åŒ–å’Œç¤¾äº¤ç½‘ç»œåˆ†äº«æ€§**ï¼šæ¸²æŸ“çš„ HTML å¯ä»¥è¢«æœç´¢å¼•æ“æœºå™¨äººç”¨æ¥ç´¢å¼•æ‚¨çš„é¡µé¢ï¼Œå¹¶è¢«ç¤¾äº¤ç½‘ç»œæœºå™¨äººç”¨æ¥ç”Ÿæˆæ‚¨é¡µé¢çš„ç¤¾äº¤å¡ç‰‡é¢„è§ˆã€‚

7. **æµå¼ä¼ è¾“**ï¼šæœåŠ¡å™¨ç»„ä»¶å…è®¸æ‚¨å°†æ¸²æŸ“å·¥ä½œåˆ†æˆå—ï¼Œå¹¶åœ¨å‡†å¤‡å°±ç»ªæ—¶å°†å®ƒä»¬æµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚è¿™ä½¿ç”¨æˆ·å¯ä»¥åœ¨æ— éœ€ç­‰å¾…æ•´ä¸ªé¡µé¢åœ¨æœåŠ¡å™¨ä¸Šæ¸²æŸ“å®Œæˆçš„æƒ…å†µä¸‹æ›´æ—©åœ°çœ‹åˆ°é¡µé¢çš„éƒ¨åˆ†ã€‚

# cache

next ä¸­ä¼šå°½å¯èƒ½çš„ç¼“å­˜æ‰€æœ‰çš„è¯·æ±‚å’Œæ¸²æŸ“å·¥ä½œã€‚

å¯¹äºå¤šæ¬¡è¯·æ±‚ï¼Œnext ä¼šå°½å¯èƒ½çš„å¤ç”¨ç¼“å­˜ä¸­çš„ Server Componentï¼Œè€Œä¸æ˜¯èµ°è¯·æ±‚å†æ¬¡è·å–ã€‚

ç±»ä¼¼ SWR ä¸€æ ·ã€‚

# è·¯ç”±

æ–‡ä»¶ç³»ç»Ÿ â†’ è·¯ç”±é…ç½®

ä»… page.js æˆ– router.js è¢«å…¬å¼€è®¿é—®ã€‚

## åµŒå¥—è·¯ç”±

![alt text](assets/image-2.png)

![alt text](assets/image-3.png)

```TypeScript
// `app/dashboard/page.tsx` is the UI for the `/dashboard` URL
export default function Page() {
  return <h1>Hello, Dashboard Page!</h1>
}
```

## è·¯ç”±ç»„

é€šè¿‡ï¼ˆï¼‰åŒ…è£¹çš„çˆ¶å±‚æ–‡ä»¶å¤¹ä¸å±äºè·¯å¾„çš„ä¸€éƒ¨åˆ†ã€‚

![alt text](assets/image-4.png)

## åŠ¨æ€è·¯ç”±

é€šè¿‡ `[xxx]` or `[...xxx]` or `[[...xxx]]` æ–¹å¼å‘½åæ–‡ä»¶å¤¹ã€‚

1. å•ä¸ªåŠ¨æ€åŒºæ®µ

   | Route                     | Example URL | `params`        |
   | ------------------------- | ----------- | --------------- |
   | `app/blog/[slug]/page.js` | `/blog/a`   | `{ slug: 'a' }` |
   | `app/blog/[slug]/page.js` | `/blog/b`   | `{ slug: 'b' }` |
   | `app/blog/[slug]/page.js` | `/blog/c`   | `{ slug: 'c' }` |

1. å¤šä¸ªåŠ¨æ€åŒºæ®µ

   | Route                        | Example URL   | `params`                    |
   | ---------------------------- | ------------- | --------------------------- |
   | `app/shop/[...slug]/page.js` | `/shop/a`     | `{ slug: ['a'] }`           |
   | `app/shop/[...slug]/page.js` | `/shop/a/b`   | `{ slug: ['a', 'b'] }`      |
   | `app/shop/[...slug]/page.js` | `/shop/a/b/c` | `{ slug: ['a', 'b', 'c'] }` |

1. å…¨éƒ¨åŠ¨æ€åŒºæ®µ

   | Route                          | Example URL   | `params`                    |
   | ------------------------------ | ------------- | --------------------------- |
   | `app/shop/[[...slug]]/page.js` | `/shop`       | `{ slug: undefined }`       |
   | `app/shop/[[...slug]]/page.js` | `/shop/a`     | `{ slug: ['a'] }`           |
   | `app/shop/[[...slug]]/page.js` | `/shop/a/b`   | `{ slug: ['a', 'b'] }`      |
   | `app/shop/[[...slug]]/page.js` | `/shop/a/b/c` | `{ slug: ['a', 'b', 'c'] }` |

## å¹¶è¡Œè·¯ç”±

ç›¸å…³é“¾æ¥ï¼š

1. [Parallel Routes](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes)

2. [useSelectedLayoutSegment(s)](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes#useselectedlayoutsegments)

é€šè¿‡ @folder å®šä¹‰ã€‚

ç±»ä¼¼ slot æ’æ§½ï¼ŒLayout ä¸­é€šè¿‡ props.folder è¯»å–ï¼Œç±»ä¼¼ childrenã€‚

![alt text](assets/image-5.png)

```TypeScript
export default function Layout({
  children,
  team,
  analytics,
}: {
  children: React.ReactNode
  analytics: React.ReactNode
  team: React.ReactNode
}) {
  return (
    <>
      {children}
      {team}
      {analytics}
    </>
  )
}
```

> å¯é€šè¿‡å®šä¹‰ default.tsx ä½œä¸ºæœ€ç»ˆçš„å¤‡é€‰å‡ºå£ã€‚

åŒæ ·åœ¨ @folder ä¸­ä¹Ÿå¯ä»¥åµŒå¥—è·¯ç”±ï¼ŒåµŒå¥—è·¯ç”±ä¹‹åï¼Œæ’æ§½åªæœ‰åœ¨è®¿é—®å¯¹åº”çš„ url ä¹‹åæ‰ä¼šæ˜¾ç¤ºã€‚

# å¸ƒå±€ & æ¨¡ç‰ˆ

`/app/layout.tsx` `/app/xxx/layout.tsx`

app è·¯ç”±ä¸­å®šä¹‰çš„ layout å³ä¸ºç»„ä»¶å±€éƒ¨è·¯ç”±å¯ä»¥è¿›è¡ŒåµŒå¥—ã€‚

Layout åˆ†ä¸ºä¸¤ç§ï¼š

1. \*Root Layoutã€Œæ ¹å¸ƒå±€ã€

2. Nesting Layoutã€ŒåµŒå¥—å¸ƒå±€ã€

> é¡¶å±‚ Root Layout æ˜¯å¿…å¤‡çš„ï¼Œglobal.css å¯åœ¨æ­¤å¤„ import ã€‚

![alt text](assets/image-6.png)

åŒæ · Template ä¹Ÿæ˜¯ç±»ä¼¼ Layout ä½œä¸ºçˆ¶å±‚æ¨¡æ¿çš„ã€‚

ä¸åŒçš„æ˜¯ï¼ŒTemplate ä¼šç»™æ¯ä¸ªå­èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå› æ­¤åœ¨å¯¼èˆªçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŒ‚åœ¨æ–°çš„å­èŠ‚ç‚¹å®ä¾‹ã€‚ã€Œé‡è½½ã€ä¸ä¼šä¿å­˜çŠ¶æ€ã€

![alt text](assets/image-7.png)

# å¯¼èˆª

ä¸‰ç§å¯¼èˆªæ–¹å¼ï¼š

1. `<Link/>`

2. [useRouter hook](https://nextjs.org/docs/app/api-reference/functions/use-router)ã€ŒCilentã€

3. redirect function ã€ŒServerã€

4. History API

## Link

åŒå…¶ä»–æ¡†æ¶ä¸€æ ·ï¼Œç”¨æ³•ç±»ä¼¼ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒLink ä¼š prefetch ã€Œé¢„åŠ è½½ã€è·¯ç”±ï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦ã€‚

## redirect

```TypeScript
import { redirect } from 'next/navigation'

async function fetchTeam(id: string) {
  const res = await fetch('https://...')
  if (!res.ok) return undefined
  return res.json()
}

export default async function Profile({ params }: { params: { id: string } }) {
  const team = await fetchTeam(params.id)
  if (!team) {
    redirect('/login')
  }

  // ...
}
```

æ³¨æ„ï¼š

1. é»˜è®¤è¿”å› 307 çŠ¶æ€ç ã€‚

2. å…¶å†…éƒ¨å¼•å‘é”™è¯¯ï¼Œå¯é€šè¿‡ try catch æ•è·ã€‚

3. å¯ä»¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åœ¨ Client Components ä¸­è°ƒç”¨ï¼Œä½†ä¸èƒ½åœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­è°ƒç”¨ï¼Œéœ€è¦æ”¹ç”¨ useRouter é’©å­ã€‚

4. æ¥å—ç»å¯¹ URLï¼Œå¯ç”¨äºé‡å®šå‘åˆ°å¤–éƒ¨é“¾æ¥ã€‚

5. åœ¨æ¸²æŸ“è¿‡ç¨‹ä¹‹å‰é‡å®šå‘ï¼Œè¯·ä½¿ç”¨ [next.config.js](https://nextjs.org/docs/app/building-your-application/routing/redirecting#redirects-in-nextconfigjs) æˆ– [Middleware](https://nextjs.org/docs/app/building-your-application/routing/redirecting#nextresponseredirect-in-middleware)ã€‚

## History API

1. window.history.pushState

2. window.history.replaceState

## è·¯ç”±å¯¼èˆªå·¥ä½œåŸç†

1. code Split

2. prefeatch

3. cache

4. partial re-render

5. soft navigation

6. back and forward navigation

7. routing between page and app

### Code Split

App Router é‡‡ç”¨æ··åˆæ¨¡å¼ç»„ç»‡è·¯ç”±å’Œå¯¼èˆªã€‚

1. åœ¨æœåŠ¡ç«¯å°†æ ¹æ®è·¯ç”±ç‰‡æ®µè¿›è¡Œæ‹†åˆ†ä»£ç ã€‚

2. å®¢æˆ·ç«¯åˆ™ä¼šå¯¹è·¯ç”±è¿›è¡Œé¢„åŠ è½½å’Œç¼“å­˜ã€‚

### Prefeatch

`<Link>` çš„é»˜è®¤é¢„å–è¡Œä¸ºï¼ˆå³å½“ `prefetch` prop æœªæŒ‡å®šæˆ–è®¾ç½®ä¸º `null` æ—¶ï¼‰æ ¹æ® `[loading.js](https://nextjs.org/docs/app/api-reference/file-conventions/loading)` çš„ä½¿ç”¨æƒ…å†µè€Œå¼‚ã€‚åªæœ‰å…±äº«å¸ƒå±€ï¼Œæ²¿ç€æ¸²æŸ“çš„ç»„ä»¶"æ ‘"ä¸€ç›´åˆ°ç¬¬ä¸€ä¸ª`loading.js`æ–‡ä»¶ï¼Œæ‰ä¼šè¢«é¢„å–å¹¶ç¼“å­˜ `30 ç§’`ã€‚

è¿™é™ä½äº†è·å–æ•´ä¸ªåŠ¨æ€è·¯ç”±çš„æˆæœ¬ï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥æ˜¾ç¤º[å³æ—¶åŠ è½½çŠ¶æ€](https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming#instant-loading-states)ï¼Œä»¥ä¾¿å‘ç”¨æˆ·æä¾›æ›´å¥½çš„è§†è§‰åé¦ˆã€‚

> é¢„åŠ è½½åªåœ¨ç”Ÿäº§ä¸Šæœ‰æ•ˆ

### Cache

Next.js å…·æœ‰ä¸€ä¸ªåä¸º [Router Cache](https://nextjs.org/docs/app/building-your-application/caching#client-side-router-cache) çš„**å†…å­˜ä¸­å®¢æˆ·ç«¯ç¼“å­˜**ã€‚

å› æ­¤åœ¨æ•´ä¸ªè·¯ç”±å¯¼èˆªçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°½å¯èƒ½çš„å¤ç”¨ç¼“å­˜ä¸­çš„ Server Componentï¼Œè€Œä¸æ˜¯èµ°è¯·æ±‚å†æ¬¡è·å–ã€‚

### Partial ReRender

éƒ¨åˆ† ReRenderï¼Œåªæœ‰æ­£åœ¨å‘ç”Ÿå¯¼èˆªçš„éƒ¨åˆ†ä¼šå‘ç”Ÿ re-renderï¼Œæ‰€æœ‰å…±äº«ç«¯éƒ½ä¸ä¼š re-renderã€‚

ä¾‹å¦‚ï¼šLayoutã€Template ç­‰ã€‚

![alt text](assets/image-8.png)

å¦‚å›¾ä¸­ï¼Œåœ¨å¯¼èˆªåˆ‡æ¢çš„æ—¶å€™åªæœ‰ setting ä»¥åŠ analytics ä¼š re-renderã€‚

### Soft Navigation

æµè§ˆå™¨**ç¡¬å¯¼èˆª** â†’ next **è½¯å¯¼èˆª**

æ²¡æ‡‚å•¥æ„æ€ ğŸ˜…

### Back And Forward Navigation

å‰è¿›å›é€€ä¼šè®°ä½æ»šåŠ¨æ¡çš„ä½ç½®ï¼Œå¹¶å¤ç”¨åŸç¼“å­˜ã€‚

### Routing Between Page And App

æ²¡æ‡‚å•¥æ„æ€ ğŸ˜…

### ç›¸å…³ API

1. [usePathname()](https://nextjs.org/docs/app/api-reference/functions/use-pathname)

2. [useSearchParams()](https://nextjs.org/docs/app/api-reference/functions/use-search-params)

3. [Router Cache](https://nextjs.org/docs/app/building-your-application/caching#client-side-router-cache)

4. [å³æ—¶åŠ è½½çŠ¶æ€](https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming#instant-loading-states)

5. [loading.js](https://nextjs.org/docs/app/api-reference/file-conventions/loading)

6. [è·¯ç”±å¯¼èˆªå·¥ä½œåŸç†](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#how-routing-and-navigation-works)

# å¼‚å¸¸æ•è·

é”™è¯¯åˆ†ä¸ºä¸¤ç§ï¼š

1. expected error é¢„æœŸé”™è¯¯

2. uncaught error æœªæ•è·é”™è¯¯

åœ¨ Server Component ä¸­é¢„æœŸé”™è¯¯ï¼Œé€šå¸¸æ¥è‡ªè¯·æ±‚è¿”å›çš„æ˜ç¡®çš„é”™è¯¯ï¼Œå¯ç›´æ¥ return å‡ºå»ã€‚

```TypeScript
'use server'

import { redirect } from 'next/navigation'

export async function createUser(prevState: any, formData: FormData) {
  const res = await fetch('https://...')
  const json = await res.json()

  if (!res.ok) {
    return { message: 'Please enter a valid email' }
  }

  redirect('/dashboard')
}
```

å…¶ä½™æœªæ•è·ã€Œæ„æ–™ä¹‹å¤–ã€çš„é”™è¯¯ï¼Œé€šå¸¸é€šè¿‡ä¸Šå±‚ ErrorBoundary æ•è·ï¼Œä¹Ÿå°±æ˜¯ error ç»„ä»¶ã€‚

åŒæ · ErrorBoundary å¯è¿›è¡ŒåµŒå¥—ï¼Œå†…å±‚ä¹Ÿå¯é€šè¿‡ throw æŠ›å‡ºå¼‚å¸¸ç»™ä¸Šå±‚æ•è·ã€‚

```TypeScript
'use client';

function Error({ error }) {
  // throw error
  return (
    <>
      about1-error
      <div>{error + ''}</div>
    </>
  );
}

export default Error;

```

# Loading

![image.png](NextJS+79d46357-6232-44c1-9442-a2028aa3992e/image 8.png)

```TypeScript
export default function Loading() {
  // You can add any UI inside Loading, including a Skeleton.
  return <LoadingSkeleton />
}
```

loading æœ€ç»ˆä¼šè¢«æ•´åˆåˆ° Suspense çš„ fallback ä¸­ã€‚

# Redirect

next ä¸­é‡å®šå‘çš„æ–¹å¼æœ‰ï¼š

| API                                                                                                                                                                                                                                                                                                                                                  | Where                                             | Status Code                            |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- | -------------------------------------- |
| `[redirect](https://nextjs.org/docs/app/building-your-application/routing/redirecting#redirect-function)`                                                                                                                                                                                                                                            | Server Components, Server Actions, Route Handlers | 307 (Temporary) or 303 (Server Action) |
| `[permanentRedirect](https://nextjs.org/docs/app/building-your-application/routing/redirecting#permanentredirect-function)`                                                                                                                                                                                                                          | Server Components, Server Actions, Route Handlers | 308 (Permanent)                        |
| `[useRouter](https://nextjs.org/docs/app/building-your-application/routing/redirecting#userouter-hook)`                                                                                                                                                                                                                                              | Event Handlers in Client Components               | N/A                                    |
| `[redirects](https://nextjs.org/docs/app/building-your-application/routing/redirecting#redirects-in-nextconfigjs)`[ in ](https://nextjs.org/docs/app/building-your-application/routing/redirecting#redirects-in-nextconfigjs)`[next.config.js](https://nextjs.org/docs/app/building-your-application/routing/redirecting#redirects-in-nextconfigjs)` | `next.config.js` file                             | 307 (Temporary) or 308 (Permanent)     |
| `[NextResponse.redirect](https://nextjs.org/docs/app/building-your-application/routing/redirecting#nextresponseredirect-in-middleware)`                                                                                                                                                                                                              | Middleware                                        | Any                                    |

## redirect

```TypeScript
'use server'

import { redirect } from 'next/navigation'
import { revalidatePath } from 'next/cache'

export async function createPost(id: string) {
  try {
    // Call database
  } catch (error) {
    // Handle errors
  }

  revalidatePath('/posts') // Update cached posts
  redirect(`/post/${id}`) // Navigate to the new post page
}
```

> é»˜è®¤è¿”å› 307ï¼Œåœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­è¿”å› 303ï¼Œè¿™é€šå¸¸ç”¨äºä½œä¸º POST è¯·æ±‚çš„ç»“æœé‡å®šå‘åˆ°æˆåŠŸé¡µé¢ã€‚

## useRouter

ç±»ä¼¼å…¶ä»–è·¯ç”±åº“ï¼Œpushã€replace è·³è½¬è·¯ç”±ã€‚

## redirects in nextConfig

```TypeScript
/** @type {import('next').NextConfig} */
const nextConfig = {
  redirects() {
    return [
      {
        // æº
        source: '/about',
        // ç›®æ ‡
        destination: '/about/about1',
        // æ°¸ä¹…é‡å®šå‘
        permanent: true,
      },
    ];
  },
};

export default nextConfig;
```

æ³¨æ„ï¼š

1. é‡å®šå‘å¯ä»¥è¿”å› 307 ï¼ˆTemporary Redirectï¼‰ æˆ– 308 ï¼ˆPermanent Redirectï¼‰ çŠ¶æ€ä»£ç ã€‚

2. é‡å®šå‘å¯èƒ½ä¼šæ”¶åˆ°å¹³å°çš„é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œåœ¨ Vercel ä¸Šï¼Œé‡å®šå‘é™åˆ¶ä¸º 1,024 æ¬¡ã€‚

3. redirect åœ¨ Middleware **ä¹‹å‰**è¿è¡Œã€‚

## NextResponse.redirect in Middleware

ä¸­é—´ä»¶å…è®¸æ‚¨åœ¨è¯·æ±‚å®Œæˆä¹‹å‰è¿è¡Œä»£ç ã€‚

ä¾‹å¦‚èº«ä»½æ ¡éªŒã€ä¼šè¯ç®¡ç†ç­‰ã€‚

```TypeScript
import { NextResponse, NextRequest } from 'next/server'
import { authenticate } from 'auth-provider'

export function middleware(request: NextRequest) {
  const isAuthenticated = authenticate(request)

  // If the user is authenticated, continue as normal
  if (isAuthenticated) {
    return NextResponse.next()
  }

  // Redirect to login page if not authenticated
  return NextResponse.redirect(new URL('/login', request.url))
}

// åŒ¹é…url
export const config = {
  matcher: '/dashboard/:path*',
}
```

## å¤§è§„æ¨¡é‡å®šå‘

1. redirect store

2. middlerware

```TypeScript
{
  "/old": {
    "destination": "/new",
    "permanent": true
  },
  "/blog/post-old": {
    "destination": "/blog/post-new",
    "permanent": true
  }
}
```

```TypeScript
import { NextResponse, NextRequest } from 'next/server'
import { get } from '@vercel/edge-config'

type RedirectEntry = {
  destination: string
  permanent: boolean
}

export async function middleware(request: NextRequest) {
  const pathname = request.nextUrl.pathname
  const redirectData = await get(pathname)

  if (redirectData && typeof redirectData === 'string') {
    const redirectEntry: RedirectEntry = JSON.parse(redirectData)
    const statusCode = redirectEntry.permanent ? 308 : 307
    return NextResponse.redirect(redirectEntry.destination, statusCode)
  }

  // No redirect found, continue without redirecting
  return NextResponse.next()
}
```

[ä¼˜åŒ–](https://nextjs.org/docs/app/building-your-application/routing/redirecting#managing-redirects-at-scale-advanced)ï¼šredisã€bloomFilter

# Font

## google font

```TypeScript
import { Inter, Roboto_Mono } from 'next/font/google'

export const inter = Inter({
  subsets: ['latin'],
  display: 'swap',
})

export const roboto_mono = Roboto_Mono({
  subsets: ['latin'],
  display: 'swap',
})
```

```TypeScript
import { inter } from './fonts'

export default function Layout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" className={inter.className}>
      <body>
        <div>{children}</div>
      </body>
    </html>
  )
}
```

**css åŠ¨æ€å˜é‡**

```TypeScript
import { Inter, Roboto_Mono } from 'next/font/google'
import styles from './global.css'

const inter = Inter({
  subsets: ['latin'],
  variable: '--font-inter',
  display: 'swap',
})

const roboto_mono = Roboto_Mono({
  subsets: ['latin'],
  variable: '--font-roboto-mono',
  display: 'swap',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" className={`${inter.variable} ${roboto_mono.variable}`}>
      <body>
        <h1>My App</h1>
        <div>{children}</div>
      </body>
    </html>
  )
}
```

## local font

```TypeScript
import localFont from 'next/font/local'

// Font files can be colocated inside of `app`
const myFont = localFont({
  src: './my-font.woff2',
  // å¤šä¸ªå­—ä½“
  // src: [],
  display: 'swap',
})

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en" className={myFont.className}>
      <body>{children}</body>
    </html>
  )
}
```

## with tailwindcss

css å˜é‡ â†’ tailwindcss.config.theme

```TypeScript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx}',
    './components/**/*.{js,ts,jsx,tsx}',
    './app/**/*.{js,ts,jsx,tsx}',
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ['var(--font-inter)'],
        mono: ['var(--font-roboto-mono)'],
      },
    },
  },
  plugins: [],
}
```

# Metadata

å¯é€šè¿‡ eport metadata å¯¹è±¡å®ç°å¯¹é¡µé¢å…ƒæ•°æ®çš„ä¿®æ”¹ï¼Œä»…åœ¨ **Server Component** ä¸­ç”Ÿæ•ˆ

egï¼šlinkã€metaã€titleã€‚

## Static Metadata

[Api Reference](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)

```TypeScript
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: '...',
  description: '...',
}

export default function Page() {
  return '...'
}
```

## Dynamic Metadata

é€šè¿‡æš´éœ² generateMetadata å‡½æ•°å®ç°ã€‚

```TypeScript
import type { Metadata, ResolvingMetadata } from 'next'

type Props = {
  params: Promise<{ id: string }>
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}

export async function generateMetadata(
  { params, searchParams }: Props,
  parent: ResolvingMetadata
): Promise<Metadata> {
  // read route params
  const id = (await params).id

  // fetch data
  const product = await fetch(`https://.../${id}`).then((res) => res.json())

  // optionally access and extend (rather than replace) parent metadata
  const previousImages = (await parent).openGraph?.images || []

  return {
    title: product.title,
    openGraph: {
      images: ['/some-specific-page-image.jpg', ...previousImages],
    },
  }
}

export default function Page({ params, searchParams }: Props) {}
```

## Meta æ–‡ä»¶

è¿™äº›æ–‡ä»¶ä¼šæœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚

- [favicon.ico, apple-icon.jpg, and icon.jpg](https://nextjs.org/docs/app/api-reference/file-conventions/metadata/app-icons)

- [opengraph-image.jpg and twitter-image.jpg](https://nextjs.org/docs/app/api-reference/file-conventions/metadata/opengraph-image)

- [robots.txt](https://nextjs.org/docs/app/api-reference/file-conventions/metadata/robots)

- [sitemap.xml](https://nextjs.org/docs/app/api-reference/file-conventions/metadata/sitemap)

# æ‡’åŠ è½½

1. `[React.lazy()](https://react.dev/reference/react/lazy)` + Suspense

2. [Dynamic Imports](https://nextjs.org/docs/app/building-your-application/optimizing/lazy-loading#nextdynamic)

```TypeScript
'use client'

import { useState } from 'react'
import dynamic from 'next/dynamic'

// Client Components:
const ComponentA = dynamic(() => import('../components/A'))
const ComponentB = dynamic(() => import('../components/B'))
const ComponentC = dynamic(() => import('../components/C'), { ssr: false })

export default function ClientComponentExample() {
  const [showMore, setShowMore] = useState(false)

  return (
    <div>
      {/* Load immediately, but in a separate client bundle */}
      <ComponentA />

      {/* Load on demand, only when/if the condition is met */}
      {showMore && <ComponentB />}
      <button onClick={() => setShowMore(!showMore)}>Toggle</button>

      {/* Load only on the client side */}
      <ComponentC />
    </div>
  )
}
```

> æœåŠ¡å™¨ç»„ä»¶ä½¿ç”¨ dynamic æ—¶ï¼Œåªæœ‰æœåŠ¡å™¨ç»„ä»¶å­çº§çš„å®¢æˆ·ç«¯ç»„ä»¶å°†è¢«å»¶è¿ŸåŠ è½½ï¼Œå¯¹æœåŠ¡å™¨ç»„ä»¶

## è·³è¿‡ SSR

ä½¿ç”¨ React.lazy å®¢æˆ·ç«¯ç»„ä»¶ä¼šé»˜è®¤é¢„æ¸²æŸ“ã€‚

é€šè¿‡ `{ ssr: false }` é…ç½®ä»¥å–æ¶ˆï¼ŒæœåŠ¡å™¨ç»„ä»¶ä¸æ”¯æŒè¯¥é…ç½®ã€‚

```TypeScript
const ComponentC = dynamic(() => import('../components/C'), { ssr: false })

/*
** dynamic options
*/
export type DynamicOptions<P = {}> = LoadableGeneratedOptions & {
    loading?: (loadingProps: DynamicOptionsLoadingProps) => JSX.Element | null;
    loader?: Loader<P> | LoaderMap;
    loadableGenerated?: LoadableGeneratedOptions;
    ssr?: boolean;
    /**
     * @deprecated `suspense` prop is not required anymore
     */
    suspense?: boolean;
};
```

# å†…ç½®ç»„ä»¶

1. [Image](https://nextjs.org/docs/app/api-reference/components/image)

2. [Script](https://nextjs.org/docs/app/api-reference/components/script)

# libs

1. [next-video](https://next-video.dev/)

2. [@next/third-parties](https://www.npmjs.com/package/@next/third-parties) ã€Œä¸‰æ–¹åº“ã€

# ç›¸å…³èµ„æ–™

1. [ä¸­æ–‡æ–‡æ¡£](https://nextjs.net.cn/)
