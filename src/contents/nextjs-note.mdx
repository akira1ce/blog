---
title: bobo nextjs notes
category: ['nextjs', 'react', 'notes']
slug: nextjs-note
date: 2024-08-21
summary: è®°å½• Next.js å­¦ä¹ è¿‡ç¨‹ä¸­çš„é‡ç‚¹çŸ¥è¯†ç‚¹å’Œå®ç”¨æŠ€å·§ã€‚
---


# ç†è§£æœåŠ¡ç«¯æ¸²æŸ“

æœåŠ¡ç«¯æ¸²æŸ“ã€ŒSSRã€ï¼Œserver-side-renderingã€‚

è¿™æ˜¯ä¸€ç§å°†é¡µé¢æ‹¼æ¥çš„å·¥ä½œæ”¾åˆ°æœåŠ¡ç«¯çš„æ¸²æŸ“æ–¹æ¡ˆã€‚ssr ä¸»è¦æ˜¯é’ˆå¯¹åŠ¨æ€å†…å®¹çš„é¡µé¢æå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

## SSR æµç¨‹

1. å®¢æˆ·ç«¯è®¿é—® urlï¼Œå‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚

2. æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œæ ¹æ®è·¯ç”±æ‰§è¡Œä¸åŒçš„é¡µé¢ç»„ä»¶

3. é¡µé¢ç»„ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå‘å…¶ä»–æœåŠ¡ç«¯æˆ–è€…æ•°æ®åº“è¯·æ±‚æ•°æ®ï¼Œè¯·æ±‚æˆåŠŸä¹‹åå†ä¸æ¨¡æ¿æ¸²æŸ“æˆå­—ç¬¦ä¸²

4. é¡µé¢ç»„ä»¶æ‰§è¡Œå®Œæ¯•ï¼Œå¾—åˆ°é¡µé¢å†…å®¹ï¼Œå‘å®¢æˆ·ç«¯è¿”å›è¯¥å†…å®¹

5. å®¢æˆ·ç«¯å¾—åˆ°å†…å®¹ä¹‹åï¼Œç”±æµè§ˆå™¨æ¸²æŸ“é¡µé¢ï¼Œè¿™æ ·å¯ä»¥åšåˆ°é¡µé¢ç›´å‡º

## SSR é¢ä¸´çš„é—®é¢˜

å¸¦æ¥ä¼˜å¼‚ SEO è¡¨ç°çš„åŒæ—¶ï¼ŒåŸå…ˆåˆ†å‘åœ¨ç”¨æˆ·å®¢æˆ·ç«¯ä¸Šçš„å‹åŠ›ï¼Œç›´æ¥è½¬ç§»åˆ°æœåŠ¡å™¨ï¼Œå½“ç”¨æˆ·è®¿é—®è§„æ¨¡ä¸Šæ¥ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šæ‰¿å—å·¨å¤§å‹åŠ›ã€‚

# åŒæ„

åŒæ„ç»„ä»¶ç»„ä»¶æŒ‡çš„æ˜¯ä¸€ä¸ª React ç»„ä»¶**æ—¢èƒ½åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ¸²æŸ“å¾—åˆ°é™æ€ html å†…å®¹ï¼Œä¹Ÿèƒ½å¤Ÿåœ¨å®¢æˆ·ç«¯æ‰§è¡Œå¾—åˆ°åŠ¨æ€äº¤äº’é€»è¾‘**ã€‚

æœåŠ¡ç«¯æ¸²æŸ“çš„äº§ç‰©æ˜¯ç®€å•çš„htmlå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ç»„ä»¶é™¤äº†é™æ€éƒ¨åˆ†ä¹‹å¤–ï¼Œè¿˜æœ‰åŠ¨æ€çš„äº¤äº’çš„é€»è¾‘ã€‚

æœ€å¥½çš„æ–¹å¼å°±æ˜¯é€šè¿‡ js è·å–åˆ°å…ƒç´ æ¥å®Œæˆè¿™ä¸ªéœ€æ±‚ï¼Œä¹Ÿå°±æ˜¯æ—©æœŸçš„ JSP/PHP+JQUERYã€‚

React åŒæ„ç»„ä»¶å¾—ç›Šäº React çš„è™šæ‹Ÿ DOMï¼Œå¯ä»¥å­˜åœ¨å‰åç«¯ä¸¤ç§å±•ç°å½¢å¼ã€‚

åœ¨æœåŠ¡ç«¯ï¼ŒReact æä¾›äº† `ReactDOMServer.renderToString` ä¸ `ReactDOMServer.renderToStaticMarkup` å°†è™šæ‹Ÿ DOM æ¸²æŸ“æˆ HTML å­—ç¬¦ä¸²ã€‚

åœ¨å®¢æˆ·ç«¯ï¼Œè™šæ‹Ÿ DOM é€šè¿‡ `ReactDOM.render` æ–¹æ³•æ¸²æŸ“æˆçœŸå® DOMã€‚

## æ°´åˆã€Œæ³¨æ°´ã€

æ°´åˆå®é™…ä¸Šå°±æ˜¯åœ¨å®¢æˆ·ç«¯ç»™é™æ€ç»„ä»¶å¢åŠ åŠ¨æ€äº¤äº’èƒ½åŠ›çš„è¿‡ç¨‹ã€‚

hydrate -> JSX -> fiber -> fiber.stateNode -> å¤ç”¨ DOM -> cilent diff

hydrate è§¦å‘çš„ diff è¿‡ç¨‹å¹¶ä¸å®Œå…¨æ˜¯ä¸€æ¬¡ DOM èŠ‚ç‚¹å…¨éƒ¨æ›¿æ¢çš„è¿‡ç¨‹ã€‚è€Œæ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­å·²ç»æ¸²æŸ“åˆ°é¡µé¢ä¸Šçš„çœŸå® DOM æ˜¯å¦å¯ä»¥è¢«å¤ç”¨çš„è¿‡ç¨‹ã€‚

React åº•å±‚æºç ä¸­æä¾›äº†å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ç”¨äºåˆ¤æ–­å¯¹åº”çš„èŠ‚ç‚¹æ˜¯å¦å¯ä»¥è¢«æ³¨æ°´ï¼Œå¦‚æœæ­¤æ—¶å¯ä»¥æ³¨æ°´åˆ™è¡¨ç¤ºå¯ä»¥å¤ç”¨ã€‚å¦‚ä¸‹é«˜äº®æ˜¾ç¤ºçš„ä»£ç ï¼Œå°±æ˜¯æ ¸å¿ƒçš„åˆ¤æ–­é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

```js
export function canHydrateInstance(
  instance: HydratableInstance,
  type: string,
  props: Props,
): null | Instance {
  if (
    instance.nodeType !== ELEMENT_NODE ||
    type.toLowerCase() !== instance.nodeName.toLowerCase()
  ) {
    return null;
  }
  // This has now been refined to an element node.
  return ((instance: any): Instance);
}

export function canHydrateTextInstance(
  instance: HydratableInstance,
  text: string,
): null | TextInstance {
  if (text === '' || instance.nodeType !== TEXT_NODE) {
    // Empty strings are not parsed by HTML so there won't be a correct match here.
    return null;
  }
  // This has now been refined to a text node.
  return ((instance: any): TextInstance);
}

export function canHydrateSuspenseInstance(
  instance: HydratableInstance,
): null | SuspenseInstance {
  if (instance.nodeType !== COMMENT_NODE) {
    // Empty strings are not parsed by HTML so there won't be a correct match here.
    return null;
  }
  // This has now been refined to a suspense node.
  return ((instance: any): SuspenseInstance);
}
```

ä½†æ˜¯è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œç”±äºæ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œå› æ­¤æ­¤æ—¶å†…å­˜ä¸­çš„ fiber æ ‘éœ€è¦å…¨éƒ¨æ ¹æ® JSX é‡æ–°åˆ›å»ºï¼Œè€Œå¤ç”¨çš„ä»…ä»…åªæ˜¯çœŸå® DOM èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬åˆ¤æ–­å‡ºæ¥çœŸå® DOM èŠ‚ç‚¹å¯ä»¥è¢«å¤ç”¨ä¹‹åï¼Œä¼šç›´æ¥å°†å…¶æ·»åŠ åˆ°å¯¹åº”çš„ fiber.stateNode ä¸Šï¼Œåœ¨åç»­çš„ completeWork æµç¨‹ä¸­ï¼Œå°±ä¸éœ€è¦åˆ›å»ºæ–°çš„çœŸå® DOMï¼Œè€Œæ˜¯ç›´æ¥å¤ç”¨ã€‚

## é¢ä¸´çš„é—®é¢˜

1. è¿è¡Œæ—¶ç¯å¢ƒä¸åŒ
2. ä¸‰æ–¹åŒ…ä¾èµ–åŒ…çš„å†—ä½™

å®¢æˆ·ç«¯æ˜¯åœ¨æµè§ˆå™¨ JS ç¯å¢ƒï¼ŒæœåŠ¡ç«¯åˆ™æ˜¯ NodeJS ç¯å¢ƒã€‚

æœ‰äº›é€»è¾‘åªæœ‰åœ¨æœåŠ¡ç«¯æ‰§è¡Œï¼Œé‚£ä¹ˆç›¸å…³é€»è¾‘çš„ä¸‰æ–¹åŒ…ï¼Œå°±æ²¡å¿…è¦æ‰“åˆ°å®¢æˆ·ç«¯ã€‚

å› æ­¤éšç€åŒæ„çš„å‘å±•ï¼Œå°†æœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶åˆ†å¼€ï¼Œæ…¢æ…¢å˜æˆäº†åˆšéœ€ï¼ŒReact Server Component å°±æ˜¯åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šï¼Œæ¼”å˜å‡ºæ¥çš„è§£å†³æ–¹æ¡ˆã€‚

# RSC

React Server Component ç®€ç§° RSCï¼Œå’ŒåŒæ„ç»„ä»¶æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œä»–è¦æ±‚å¼€å‘è€…åœ¨å¼€å‘ä¸­å°±å°†å®¢æˆ·ç«¯ç»„ä»¶ä¸æœåŠ¡ç«¯ç»„ä»¶ä¸¥æ ¼åŒºåˆ†å¼€ã€‚æŠŠæœåŠ¡ç«¯ç»„ä»¶ä»åŒæ„ç»„ä»¶ä¸­æ‹†ç¦»å‡ºæ¥ï¼Œè®©æœåŠ¡ç«¯ç»„ä»¶åªåœ¨æœåŠ¡ç«¯è¿è¡Œï¼Œæ˜¯ RSC çš„æ ¸å¿ƒç†å¿µä¹‹ä¸€ã€‚

åœ¨ nextjs ä¸­å¯é€šè¿‡ `use cilent` å’Œ `use server` åœ¨ç•Œå®šç»„ä»¶ç±»å‹ã€‚

å½“ç„¶é»˜è®¤ä¸å†™å°±æ˜¯æœåŠ¡ç«¯ç»„ä»¶ã€‚

ä¼˜åŠ¿ï¼š

1. å®¢æˆ·ç«¯çš„æ‰“åŒ…ä½“ç§¯å¤§å¹…å‡å°
2. ç›´æ¥è®¿é—®æœåŠ¡å™¨èµ„æº
3. å®‰å…¨æ€§æå‡

# React ä¼˜åŒ–

## React Fiber Diff

Reactä¸‰å¤§å…ƒç´ å¯¹è±¡ï¼šè™šæ‹ŸDOMã€Fiberå¯¹è±¡ã€çœŸå®DOMã€‚

JSX -> vNode -> Fiber -> Dom

React Diff ä¸‰è¦ç´ ï¼šstateã€propsã€contextã€‚

ä¼˜åŒ–æ€è·¯ï¼š

æ ¸å¿ƒåœ¨äºï¼Œå¦‚ä½•ç¡®ä¿ä¸€ä¸ªç¨³å®šçš„ç¯å¢ƒæˆ–å¼•ç”¨ã€‚

1. æ‹†åˆ†è§£è€¦
2. å…¨å±€çŠ¶æ€ç®¡ç†

æ‹†åˆ†èƒ½åŠ› -> nextjs ä¸­å¯¹äºæœåŠ¡ç«¯ã€å®¢æˆ·ç«¯ç»„ä»¶çš„æ‹†åˆ†

åªæ¸²æŸ“ä¸€æ¬¡çš„æ‹†åˆ†ä¸ºæœåŠ¡ç«¯ç»„ä»¶ï¼Œéœ€è¦å¤šæ¬¡æ¸²æŸ“çš„æ‹†åˆ†ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ã€‚

# next

`"use client"` å½“åšå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¾¹ç•Œã€‚

> æ³¨æ„ï¼š è¿™é‡Œçš„è¾¹ç•ŒæŒ‡çš„æ˜¯ï¼Œ**æ¨¡å—ç»“æ„**çš„è¾¹ç•Œã€‚
> 
> æ¨¡å—è¾¹ç•Œæ˜¯ç”±æ¨¡å—é—´`import`ç»„æˆçš„ï¼Œå®ƒä¸æ˜¯æ–‡ä»¶ç»“æ„æ ‘ã€‚ä¹Ÿä¸æ˜¯ Fiber treeï¼Œä¸æ˜¯çˆ¶å­ç»„ä»¶ä¹‹é—´çš„å…³ç³»ã€‚

ğŸŒ° å¦‚ä¸‹ï¼š

```tsx
// Layout.tsx
import './globals.css'
import {ThemeProvider} from '@/components/switch-themes'

export const metadata = {
  title: 'è¿™æ³¢èƒ½åæ€çš„ä»˜è´¹è¯¾',
  description: 'Generated by Next.js',
}

export default async function RootLayout({ children }: any) {
  return (
    <html lang="zh" suppressHydrationWarning className='bg-background h-full'>
      <body className='text-sm text-foreground h-full'>
        {/* ThemeProvider */}
        <ThemeProvider defaultTheme='light'>
          {/* Page */}
          {children}
        </ThemeProvider>
      </body>
    </html>
  )
}
```

```txt
// æ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯æ¨¡å—ç»“æ„æ ‘. è¯¥æ¨¡å—ç»“æ„æ ‘ï¼Œç”± import å¼•å…¥ç»„æˆ
//  + è¡¨ç¤ºè¿˜æœ‰å­èŠ‚ç‚¹ï¼Œ- è¡¨ç¤ºå¶å­èŠ‚ç‚¹
+ Layout.tsx
  - ThemeProvider.tsx // æ­¤æ—¶ context æ˜¯æ ‘å½¢ç»“æ„ä¸­çš„å¶å­ç»“ç‚¹
  + page.tsx
    + component1.tsx
    + component2.tsx
    + ...
```

## project-structure

next ä¸­é‡‡ç”¨çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼Œå› æ­¤é¡¹ç›®ç»“æ„ä¸­ï¼Œæ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„å±‚çº§ç»“æ„ï¼Œå†³å®šäº†è·¯ç”±çš„ç»“æ„ã€‚

[project-structure](https://nextjs.org/docs/app/getting-started/project-structure)


## app-router

next ä¹Ÿæ˜¯æ ‡å‡†çš„åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±ç³»ç»Ÿã€‚

å®é™…ä¸Šï¼Œæˆ‘ä»¬å¸¸ç”¨çš„é…ç½®å¼è·¯ç”±ï¼Œé¬¼ä½¿ç¥å·®çš„æˆ‘ä»¬ä¹Ÿæ˜¯æ ¹æ®æ–‡ä»¶æ¥æ¥ç•Œå®šæˆ‘ä»¬çš„è·¯ç”±çš„ã€‚

æ–‡ä»¶å¼è·¯ç”±åè€Œçœå»äº†æˆ‘ä»¬é…ç½®çš„å†ç¨‹ï¼Œåœ¨åç»­è·¯ç”±å‡ºç°å˜æ›´çš„æ—¶å€™ä¹Ÿç›¸å¯¹æ¯”è¾ƒå¥½æ¥è¿›è¡Œå˜æ›´ã€‚

ä¾‹å¦‚æˆ‘ä»¬ä¹‹å‰é¡¹ç›®ä¸Šå­˜åœ¨ï¼Œä¸€æ¬¡å‡ ä¹ä¸€èˆ¬çš„è·¯ç”±éœ€è¦è°ƒæ•´ä½ç½®ï¼Œè™½ç„¶æˆ‘ä»¬ä¹Ÿæ˜¯åŠ¨æ€åç«¯è·¯ç”±ï¼Œå¯åœ¨é¡µé¢ç›´æ¥é…ç½®ï¼Œä½†æ˜¯ä¹Ÿå¯¼è‡´åç»­ä¿®æ”¹è¿‡çš„è·¯ç”±å’Œæ–‡ä»¶æ²¡æœ‰ä¸€ä¸€å¯¹åº”ï¼Œè¿™ä¹Ÿç»™åç»­ç»´æŠ¤å¸¦æ¥äº†ä¸€å®šæˆæœ¬ã€‚

ä½†åŸºäºæ–‡ä»¶å¯èƒ½å°±ä¸ä¸€æ ·äº†ï¼Œæˆ‘ä»¬å¯ç›´æ¥é€šè¿‡ copy çš„æ–¹å¼ï¼Œæ‹·è´æ–°çš„è·¯ç”±çš„åŒæ—¶ï¼Œä¿ç•™åŸè·¯ç”±ä¸€æ®µæ—¶é—´ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›æ—§çš„è·¯ç”±åšæ˜¾å¼çš„è·³è½¬æç¤ºï¼Œå¹¶å‘ŠçŸ¥åç»­ä¼šä¸åœ¨ç»´æŠ¤ï¼Œä¸€æ–¹é¢ç»™ç”¨æˆ·ç¼“å†²çš„æ—¶é—´ï¼Œå†è€…ä¹Ÿä¿è¯äº†åç»­è·¯ç”±å’Œæ–‡ä»¶çš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚

### è·¯ç”±è·³è½¬

1. Link
2. useRouter
3. redirect
4. history api

åŒæ ·è·¯ç”±å¯ä¼ é€’ state æˆ– query å‚æ•°ï¼Œå¯é€šè¿‡ `useSearchParams` è·å–ã€‚

### è·¯ç”±åŠ è½½åŸç†

1. æ··åˆ
2. é¢„åŠ è½½
3. è·¯ç”±ç¼“å­˜
4. éƒ¨åˆ†æ¸²æŸ“

*æ··åˆ*

åœ¨ history router ä¸‹ï¼Œçº¯å®¢æˆ·ç«¯çš„è·¯ç”±è·³è½¬ï¼Œä¸ä¼šå¾€æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¹Ÿæ— æ³•æ„ŸçŸ¥åˆ°è·¯ç”±åˆ‡æ¢ã€‚

è€Œç”±æµè§ˆå™¨åˆ·æ–°æ“ä½œï¼Œå‘èµ·çš„ç¡¬å¯¼èˆªï¼Œä¼šé‡æ–°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯æ²¡æœ‰åšç‰¹æ®Šå¤„ç†ï¼Œå°±ä¼šå‡ºç° 404 çš„æŠ¥é”™ã€‚

åœ¨ NextJS çš„ App Router è®¾è®¡ä¸­ï¼Œå¯¹è¿™ä¸¤ç§æƒ…å†µåšäº†æ··åˆå¤„ç†ã€‚

åœ¨æœåŠ¡ç«¯ï¼Œä»£ç ä¼šæŒ‰ç…§è·¯ç”±æ®µè¿›è¡Œæ‹†åˆ†ï¼Œä»è€Œåˆ†å‰²æˆæ›´å°çš„åŒ…ã€‚å½“åˆ·æ–°æµè§ˆå™¨è®¿é—®åˆ°æœåŠ¡ç«¯æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»…ä¸‹è½½è¯¥è·¯ç”±å¯¹åº”çš„ä»£ç ã€‚

åœ¨å®¢æˆ·ç«¯ï¼Œè·¯ç”±æ‰€å¯¹åº”çš„ä»£ç å¯ä»¥é€šè¿‡é¢„è¯»å–çš„æ–¹æ³•ï¼Œç¡®ä¿è·¯ç”±åˆ‡æ¢æ—¶çš„æµç•…ä½“éªŒã€‚

è¿™ç§æ··åˆçš„æ–¹å¼æœ‰æ•ˆè§£å†³äº†æˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„é—®é¢˜ã€‚

**é¢„åŠ è½½**

è§å­—å¦‚é¢ï¼Œé¢„å…ˆåŠ è½½è·¯ç”±ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`<Link>` ç»„ä»¶å‡ºç°åœ¨è§†å£å¯è§†åŒºåŸŸï¼Œå°±ä¼šè¿›è¡Œé¢„åŠ è½½è·¯ç”±æ‰€éœ€è¦çš„å†…å®¹ã€‚

å½“ç„¶æˆ‘ä»¬ä¹Ÿè¯¾å¯ä»¥é€šè¿‡ `prefetch` å±æ€§æ§åˆ¶ã€‚

> é¢„åŠ è½½çš„å†…å®¹ä¸»è¦ä¸º Rreact Server Component Payloadï¼Œè¿™æ˜¯ RSC æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯é€šä¿¡çš„ä¸»è¦ä¼ è¾“å†…å®¹å’Œæ•°æ®æ ¼å¼ã€‚å®ƒä¸æ¯æ¬¡æ¸²æŸ“ç”Ÿæˆçš„ Fiber æ ‘ä¸¥æ ¼å¯¹åº”ï¼Œæ˜¯ Fiber çš„å‹ç¼©å½¢å¼ã€‚

**è·¯ç”±ç¼“å­˜**

å®¢æˆ·ç«¯è®¿é—®è¿‡çš„è·¯ç”±é¡µé¢çš„ä¿¡æ¯ä¸é¢„åŠ è½½çš„ä¿¡æ¯ã€ŒRSC Payloadã€ï¼Œä¼šè¢«ç¼“å­˜åœ¨ `React Cache` ä¸­ã€‚

åœ¨åç»­è·¯ç”±åˆ‡æ¢çš„æ—¶å€™ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œè€Œä¸æ˜¯æ€»æ˜¯å‘æœåŠ¡ç«¯è¯·æ±‚ã€‚

è¿™é‡Œç¼“å­˜çš„æ˜¯é¡µé¢ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é¡µé¢ï¼Œé¡µé¢ç¼“å­˜å¯é€šè¿‡ `staleTimes` é…ç½®ã€Œnext.config.jsã€ã€‚

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    staleTimes: {
      dynamic: 30, // é’ˆå¯¹ ssrï¼Œéé™æ€ã€Link çš„ prefetch ä¸ä¸º true
      static: 180, // é™æ€ï¼Œæˆ–è€… Link çš„ prefetch ä¸º true
    },
  },
}

module.exports = nextConfig
```

**éƒ¨åˆ†æ¸²æŸ“**

åªæœ‰æ­£åœ¨åˆ‡æ¢çš„è·¯ç”±ä¼šé‡æ–°æ¸²æŸ“ï¼Œè€Œå…±äº«çš„éƒ¨åˆ†åˆ™ä¸ä¼šæ¸²æŸ“ã€ŒLayoutã€Templateã€ã€‚

## Link

ä¸»è¦å‚æ•°ï¼š

1. href - è·³è½¬çš„è·¯ç”±
2. prefetch - é¢„åŠ è½½è·¯ç”±
3. shallow - æ˜¯å¦æµ…è·³è½¬
4. scroll - æ˜¯å¦æ»šåŠ¨åˆ°é¡¶éƒ¨
5. replace - æ˜¯å¦æ›¿æ¢å½“å‰è·¯ç”±
6. as - è·¯ç”±åˆ†ç±»ã€Œå¯ä»¥å½“ä½œè·¯ç”±çš„åˆ«å-ä¸­é—´ä»¶ä¸­ä¼šä½¿ç”¨åˆ°ã€

### ä¸­é—´ä»¶

åœ¨ä¸­é—´ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè¿›è¡Œèº«ä»½éªŒè¯ï¼Œç„¶åå°†é¡µé¢æ ¹æ®éªŒè¯ç»“æœè·³è½¬åˆ°ä¸åŒçš„è·¯ç”±ä¸­ã€‚æ­¤æ—¶ï¼Œhref çš„ç»“æœæ˜¯åŠ¨æ€çš„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æé«˜é¢„è®¾ä¸€ä¸ªéœ€è¦é¢„åŠ è½½çš„é¡µé¢å†…å®¹ã€‚å¯ä»¥é€šè¿‡ as å±æ€§æ¥åšåˆ°è¿™ä¸ªäº‹æƒ…ã€‚

ä¸­é—´ä»¶ï¼š

```ts
// middleware.ts
import { NextResponse } from 'next/server'

export function middleware(request: Request) {
  const nextUrl = request.nextUrl
  if (nextUrl.pathname === '/dashboard') {
    if (request.cookies.authToken) {
      return NextResponse.rewrite(new URL('/auth/dashboard', request.url))
    } else {
      return NextResponse.rewrite(new URL('/public/dashboard', request.url))
    }
  }
}
```

page ä¸­çš„é€»è¾‘ï¼š

```tsx
// page.tsx
'use client'

import Link from 'next/link'
import useIsAuthed from './hooks/useIsAuthed' // Your auth hook

export default function Page() {
  const isAuthed = useIsAuthed()
  const path = isAuthed ? '/auth/dashboard' : '/public/dashboard'
  return (
    <Link as="/dashboard" href={path}>
      Dashboard
    </Link>
  )
}
```

## è·¯ç”±åˆ†ç»„

next ä¸­å¯é€šè¿‡ `(groupName)` å®ç°è·¯ç”±åˆ†ç»„ã€‚

> æ³¨æ„è·¯ç”±åˆ†ç»„åï¼Œä¸ä¼šå½±å“è·¯ç”±çš„è·¯å¾„ã€‚
> 
> åŒæ ·ï¼Œåˆ†ç»„åçš„è·¯ç”±ä¸­éƒ½å¯ä»¥è‡ªå®šä¹‰ layoutã€loadingã€error ç­‰ã€‚

![alt text](https://cdn.jsdelivr.net/gh/akira1ce/blog-images@main/20250614191748873.png)

## åŠ¨æ€è·¯ç”±

next ä¸­å¯é€šè¿‡ `[xxx]` å®ç°åŠ¨æ€è·¯ç”±ã€‚

1. [slug] - å•ä¸ªåŠ¨æ€è·¯ç”±æ®µ
2. [...slug] - å¤šä¸ªåŠ¨æ€è·¯ç”±æ®µ
3. [[...slug]] - æ‰€æœ‰åŠ¨æ€è·¯ç”±æ®µ

æˆ‘ä»¬å¯ä»¥åœ¨ layout page route generateMetadata ä¸­è·å¾—åŠ¨æ€è·¯ç”±æ®µçš„å‚æ•°ã€‚

```tsx
export async function generateStaticParams() {
  return [{ slug: 'article' }, { slug: 'demo' }];
}

export default function Page({ params }: { params: { slug: string } }) {
  return <div>Hello, {params.slug}!</div>;
}
```

ä½†è¿™é‡Œé™æ€ç”Ÿæˆï¼Œå¦‚æœæ•°é‡å¾ˆå¤§ï¼Œä¹Ÿä¼šå¯¼è‡´æ„å»ºæ—¶é—´è¿‡é•¿ã€å†…å­˜å ç”¨è¿‡é«˜ã€‚

å› æ­¤é™æ€ç”Ÿæˆï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥å†³å®šã€‚

## server-render

æœåŠ¡ç«¯ç»„ä»¶ï¼šåªåœ¨æœåŠ¡ç«¯æ‰§è¡Œçš„ç»„ä»¶ã€‚

åœ¨ next ä¸­ï¼Œæ¸²æŸ“å·¥ä½œæŒ‰ç…§è·¯ç”±æ®µè¿›è¡Œæ‹†åˆ†ï¼Œä»¥å®ç°æµå¼æ¸²æŸ“ä¸éƒ¨åˆ†æ¸²æŸ“ã€‚

æµå¼ä¼ è¾“èƒ½å¤Ÿæ›´å¿«çš„è®©é¡µé¢å…·å¤‡äº¤äº’èƒ½åŠ›ã€‚ç”±äºé¦–å±ç›´å‡ºä¹‹åï¼Œé¡µé¢è™½ç„¶å¿«é€Ÿçš„å‘ˆç°äº†æœ‰æ•ˆå†…å®¹ï¼Œä½†æ˜¯è¿˜æ— æ³•æ‰§è¡Œäº¤äº’é€»è¾‘ï¼Œæ­¤æ—¶éœ€è¦æœ‰ä¸€ä¸ªå®Œæ•´çš„æ°´åˆè¿‡ç¨‹ã€‚æµå¼ä¼ è¾“å¯ä»¥å°†æ¸²æŸ“å·¥ä½œæ‹†åˆ†æˆå¤šä¸ªå—ï¼Œæå‰å®Œæˆä¸€éƒ¨åˆ†é¡µé¢å†…å®¹çš„æ°´åˆï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªé¡µé¢éƒ½æ°´åˆå®Œæˆä¹‹åæ‰èƒ½äº¤äº’

**æœåŠ¡ç«¯ç»„ä»¶çš„å¥½å¤„**

1. æ›´è¿‘çš„æ•°æ®è·å–
2. æ›´å®‰å…¨çš„æ•°æ®æ“ä½œ
3. ç¼“å­˜
4. æ›´å°çš„æ‰“åŒ…ä½“ç§¯
5. é¦–å±ç›´å‡º
6. SEO

åœ¨ next ä¸­ï¼Œæˆ‘ä»¬åœ¨è®¿é—®é¡µé¢çš„æ—¶å€™ï¼Œä¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚ä¸­ä¼šåŒ…å«ä¸€ä¸ª `_rsc` å‚æ•°ï¼Œè¯¥å‚æ•°çš„å€¼ä¸º `rxx9e`ï¼Œè¯¥å‚æ•°çš„å€¼æ˜¯éšæœºç”Ÿæˆçš„ï¼Œç”¨äºæ ‡è¯†è¯¥è¯·æ±‚æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ã€‚

è¿”å›çš„å“åº”å³ RSC Payloadï¼Œè¯¥ Payload ä¸­åŒ…å«äº†é¡µé¢ä¸­æ‰€æœ‰çš„ç»„ä»¶ï¼Œä»¥åŠç»„ä»¶çš„ propsã€‚

RSC Payload æ˜¯æ¸²æŸ“ React Server Components æ ‘çš„å‹ç¼©æ ¼å¼ï¼Œå®ƒå®Œæ•´çš„è®°å½•äº†ä»£ç åœ¨é¡¹ç›®ä¸­çš„æ¨¡å—ç»“æ„ã€æ¸²æŸ“ç»“æœã€props ä¼ é€’å†…å®¹ã€‚

```
//article?_rsc=rxx9e

1:"$Sreact.fragment"
2:I["[project]/node_modules/next/dist/client/components/layout-router.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"default"]
3:I["[project]/node_modules/next/dist/client/components/render-from-template-context.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"default"]
6:I["[project]/node_modules/next/dist/client/app-dir/link.js [app-client] (ecmascript)",["static/chunks/_e1f41f._.js","static/chunks/src_app_layout_tsx_61af54._.js","static/chunks/node_modules_3c5980._.js","static/chunks/src_2bfdc8._.js","static/chunks/node_modules_lucide-react_dist_esm_icons_86be41._.js","static/chunks/src_app_article_page_tsx_e73084._.js"],"default"]
7:I["[project]/src/app/article/tooltip.tsx [app-client] (ecmascript)",["static/chunks/_e1f41f._.js","static/chunks/src_app_layout_tsx_61af54._.js","static/chunks/node_modules_3c5980._.js","static/chunks/src_2bfdc8._.js","static/chunks/node_modules_lucide-react_dist_esm_icons_86be41._.js","static/chunks/src_app_article_page_tsx_e73084._.js"],"default"]
8:I["[project]/node_modules/next/dist/lib/metadata/metadata-boundary.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"OutletBoundary"]
c:I["[project]/node_modules/next/dist/client/components/client-page.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"ClientPageRoot"]
d:I["[project]/node_modules/next/dist/client/components/client-segment.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"ClientSegmentRoot"]
e:I["[project]/node_modules/next/dist/client/components/error-boundary.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"default"]
f:I["[project]/node_modules/next/dist/client/components/http-access-fallback/error-boundary.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"HTTPAccessFallbackBoundary"]
10:I["[project]/node_modules/next/dist/lib/metadata/metadata-boundary.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"MetadataBoundary"]
11:I["[project]/node_modules/next/dist/lib/metadata/metadata-boundary.js [app-client] (ecmascript)",["static/chunks/_a91c21._.js","static/chunks/src_app_favicon_ico_mjs_ddfdf0._.js"],"ViewportBoundary"]
12:"$SkResourceStore"
5:{"name":"Page","env":"Server","key":null,"owner":null,"props":{"params":"$@","searchParams":"$@"}}
4:D"$5"
4:[["$","$L6",null,{"href":"/article/111","children":"/article/111"},"$5"],["$","p",null,{"children":"These new APIs improve on renderToString by waiting for data to load for static HTML generation. They are designed to work with streaming environments like Node.js Streams and Web Streams. For example, in a Web Stream environment, you can prerender a React tree to static HTML with prerender"},"$5"],["$","p",null,{"children":"Prerender APIs will wait for all data to load before returning the static HTML stream. Streams can be converted to strings, or sent with a streaming response."},"$5"],["$","p",null,{"children":"... ..."},"$5"],["$","$L7",null,{},"$5"]]
a:{"name":"__next_outlet_boundary__","env":"Server","key":null,"owner":null,"props":{"ready":"$E(async function getMetadataAndViewportReady() {\n        await viewport();\n        await metadata();\n        return undefined;\n    })"}}
9:D"$a"
...
```

å…¶ä¸­éƒ¨åˆ†è¯­ä¹‰ï¼š

1. $ï¼šè¡¨ç¤ºæŸä¸ªæœåŠ¡å™¨ç»„ä»¶ç”Ÿæˆçš„ DOM å®šä¹‰ã€‚
2. Iï¼šè¡¨ç¤ºä¸€ä¸ªæ¨¡å—ï¼Œä»–ä»¬è°ƒç”¨ç‰¹å®šçš„è„šæœ¬ï¼Œè¿™ä¹Ÿæ˜¯å®¢æˆ·ç«¯ç»„ä»¶å¦‚ä½•è¢«åŠ è½½çš„æ–¹å¼ï¼ˆç›´æ¥æ‰§è¡Œæˆ–è€…æ‡’åŠ è½½ï¼‰ã€‚
3. HLï¼šè¡¨ç¤ºæç¤ºï¼Œå¹¶è¿æ¥åˆ°ç‰¹å®šçš„èµ„æºï¼Œä¾‹å¦‚ css æˆ–è€…å­—ä½“ç­‰

RSC Payload åŒ…å«çš„å†…å®¹å…·ä½“æœ‰

1. æœåŠ¡å™¨ç»„ä»¶çš„æ¸²æŸ“ç»“æœ HTML ç‰‡æ®µ
2. å®¢æˆ·ç«¯ç»„ä»¶åº”è¯¥å‘ˆç°çš„ä½ç½®å ä½ç¬¦ï¼ŒåŠå…¶å¯¹ä»£ç æ¨¡å—çš„å¼•ç”¨åœ°å€
3. ä»æœåŠ¡å™¨ç»„ä»¶ä¼ é€’åˆ°å®¢æˆ·ç«¯ç»„ä»¶çš„ä»»ä½• props

**æ¸²æŸ“ç­–ç•¥**

1. é™æ€æ¸²æŸ“ã€ŒSSGã€
2. åŠ¨æ€æ¸²æŸ“ã€ŒSSRã€

next ä¸­ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„æ¸²æŸ“ç­–ç•¥ã€‚

ä¾‹å¦‚ä½¿ç”¨åˆ°ä¸€äº›è·å–åŠ¨æ€æ•°æ®çš„ APIï¼Œåˆ™ä¼šé€‰æ‹© SSR æ¸²æŸ“ï¼š

1. cookies
2. headers
3. connection
4. draftMode
5. searchParams
6. unstable_noStore

**æˆ‘ä»¬æ— éœ€å»è®°å¿†è¿™äº› API å…·ä½“æœ‰å“ªäº›ï¼Œåªæœ‰ä¸€ä¸ªæ ‡å‡†ï¼šé‚£å°±æ˜¯ä½ è¯•å›¾è·å–æœ€æ–°æ•°æ®ã€çŠ¶æ€ã€å‚æ•°æ—¶ï¼Œä½ è‡ªç„¶ä¼šä½¿ç”¨åˆ°ä»–ä»¬ã€‚**

## æœ€ä½³å®è·µ

1. Dark Mode

### Dark Mode

ä¸»è¦å®ç°æ€è·¯ï¼šhtml æ ‡ç­¾ä¸­æ·»åŠ  className='dark' å±æ€§ï¼Œç„¶åé€šè¿‡ css æ¥å®ç°ä¸»é¢˜åˆ‡æ¢ã€‚

éœ€è¦è€ƒè™‘çš„ç‚¹æ˜¯ç”¨æˆ·é€‰æ‹©ä¸»é¢˜åï¼Œç¼“å­˜çš„é—®é¢˜ã€‚

ç¼“å­˜çš„æ–¹æ¡ˆï¼š

1. ä½¿ç”¨ localStorage ç¼“å­˜
2. ä½¿ç”¨ cookie ç¼“å­˜

localStorage åªèƒ½åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œå¯¼è‡´é¡µé¢ä¼šå­˜åœ¨é—ªçƒçš„é—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨å®¢æˆ·ç«¯ç»„ä»¶ä¼šåœ¨æœåŠ¡ç«¯è¿è¡Œä¸€æ¬¡ï¼Œæå‰è®¾ç½®`html-className`ã€‚

ä½†æ­¤æ—¶ï¼Œä¸€å®šä¼šå¯¼è‡´ html ä¸­çš„ className å±æ€§çš„æ›¿æ¢ï¼Œå¯¼è‡´æ°´åˆå¤±è´¥ã€‚ã€Œæš‚æ—¶æ²¡æ‰¾åˆ°å¥½çš„è§£å†³æ–¹æ¡ˆã€