---
title: react 19 notes
category: ['react', 'notes']
slug: react-19-note
date: 2024-10-20
summary: è®°å½• React 19 ç‰ˆæœ¬çš„æ ¸å¿ƒæ›´æ–°ä¸åŸºç¡€ç”¨æ³•ã€‚
---


ã€Œæ–°çš„ APIã€

- use

- useActionState

- useFormStatus

- useOptimistic



ã€Œæ ¸å¿ƒã€

- 19 çš„å¼€å‘è€…æ„å›¾å¼•å¯¼ç”¨æˆ·**å¼±åŒ–**å¯¹äº **useEffect** çš„ä¾èµ–ã€‚

- **å¹¶å‘æ¨¡å¼**

- **React Compiler**

- **Form Action**



# use

> promise â†’ state

åˆ©ç”¨ use å¯ä»¥è·å–åˆ° promiseã€context ä¸­çš„å€¼ã€‚

è¿™é‡Œæˆ‘ä»¬éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œ**Promise** æ˜¯æŒ‡çš„ä¸€ä¸ªå·²ç»åˆ›å»ºå¥½çš„ Promise å¯¹è±¡ï¼Œå¹¶ä¸”ï¼Œåœ¨è¯¥ promise å¯¹è±¡ä¸­å·²ç»æœ‰äº†ç¡®å®šçš„ `resolve` çš„ç»“æœï¼Œuse è¯»å–çš„æ˜¯ resolve çš„å€¼ã€‚

```TypeScript
const _api2 = new Promise((resolve) => {
  resolve({ value: '_api2' })
})

// good
const result = use(_api2)
```

ä½† use ä¸èƒ½è¯»å–åˆ° return Promise ä¸­çš„å€¼ï¼Œä¸”ä¼šæŠ¥é”™ã€‚

```TypeScript
const _api3 = () => {
  return new Promise(resolve => {
    resolve({ value: '_api3' })
  })
}

// bad: get an error
const result = use(_api3())
```

![alt text](https://cdn.jsdelivr.net/gh/akira1ce/blog-images@main/20250614192059361.png)

æ­¤æ—¶å°±éœ€è¦ Suspense çš„ä»‹å…¥ã€‚

> ä¸å…¶ä»– hooks ä¸ä¸€æ ·çš„æ˜¯ï¼Œuse å¯ä»¥åœ¨å¾ªç¯å’Œæ¡ä»¶åˆ¤æ–­è¯­å¥ä¸­ä½¿ç”¨ã€‚
å¯å°†å…¶å½“åšå·¥å…·å‡½æ•°çœ‹å¾…ã€‚

# Suspense

`Suspense` èƒ½å¤Ÿæ•è·åˆ°å­ç»„ä»¶é¦–æ¬¡æ¸²æŸ“çš„å¼‚å¸¸ã€‚å› æ­¤æˆ‘ä»¬å¸¸å¸¸å°† `Suspense` å½“æˆä¸€ç§ç»„ä»¶é”™è¯¯è¾¹ç•Œæ¥å¤„ç†ã€‚

```JavaScript
import {use, Suspense} from 'react'
import Message from './Message'

const _api3 = () => {
  return new Promise(resolve => {
    resolve({ value: 'React does not preserve any state for renders that got suspended before they were able to mount for the first time. When the component has loaded, React will retry rendering the suspended tree from scratch.' })
  })
}

export default function Demo01() {
  const promise = _api3()
  return (
    <Suspense fallback=''>
      <Content promise={promise} />
    </Suspense>
  )
}

function Content(props) {
  const {value} = use(props.promise)
  return (
    <Message message={value} />
  )
}
```

## å·¥ä½œåŸç†

Suspense æä¾›äº†ä¸€ä¸ªåŠ è½½æ•°æ®çš„æ ‡å‡†ã€‚åœ¨æºç ä¸­ï¼ŒSuspense çš„å­ç»„ä»¶è¢«ç§°ä¸º `primary`ã€‚

å½“ react åœ¨ beginWork çš„è¿‡ç¨‹ä¸­ï¼ˆdiff è¿‡ç¨‹ï¼‰ï¼Œé‡åˆ° `Suspense` æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•åŠ è½½ `primary` ç»„ä»¶ã€‚å¦‚æœ `primary` ç»„ä»¶åªæ˜¯ä¸€ä¸ªæ™®é€šç»„ä»¶ï¼Œé‚£ä¹ˆå°±é¡ºåˆ©æ¸²æŸ“å®Œæˆã€‚

å¦‚æœ `primary` ç»„ä»¶æ˜¯ä¸€ä¸ªåŒ…å«äº† use è¯»å–å¼‚æ­¥ promise çš„ç»„ä»¶ï¼Œå®ƒä¼šåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œ**æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸**ã€‚react æ•è·åˆ°è¯¥å¼‚å¸¸ä¹‹åï¼Œå‘ç°æ˜¯ä¸€ä¸ªæˆ‘ä»¬åœ¨è¯­æ³•ä¸­çº¦å®šå¥½çš„ promiseï¼Œé‚£ä¹ˆå°±ä¼šå°†å…¶ `then` çš„å›è°ƒå‡½æ•°ä¿å­˜ä¸‹æ¥ï¼Œå¹¶å°†ä¸‹ä¸€ä¸ª `next` beginWork çš„ç»„ä»¶é‡æ–°æŒ‡å®šä¸º `Suspense`ã€‚

æ­¤æ—¶ promise åœ¨è¯·æ±‚é˜¶æ®µï¼Œå› æ­¤å†æ¬¡ beginWork Suspense ç»„ä»¶æ—¶ï¼Œä¼šè·³è¿‡ `primary` çš„æ‰§è¡Œè€Œç›´æ¥æ¸²æŸ“ `fallback`

å½“ `primary` ä¸­çš„ promise æ‰§è¡Œå®Œæˆæ—¶ã€Œresolveã€ï¼Œä¼šæ‰§è¡Œåˆšæ‰ä¿å­˜çš„ `then` æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šè§¦å‘ `Suspense` å†æ¬¡æ‰§è¡Œã€Œè°ƒåº¦ä¸€ä¸ªæ›´æ–°ä»»åŠ¡ã€ã€‚ç”±äºæ­¤æ—¶ `primary` ä¸­çš„ promise å·²ç» resolveï¼Œå› æ­¤æ­¤æ—¶å°±å¯ä»¥æ‹¿åˆ°æ•°æ®ç›´æ¥æ¸²æŸ“ `primary` ç»„ä»¶ã€‚

```Shell
Suspense ->
primary -> 
Suspense -> 
fallback -> 
waiting -> resolve() -> 
Suspense -> 
primary -> 
```

åœ¨ Suspense çš„åŠ æŒä¸‹ï¼Œå¼‚æ­¥è¯·æ±‚ä¸å†éœ€è¦åœ¨ useEffect ä¸­æ‰§è¡Œï¼Œä¹Ÿä¸å†éœ€è¦ re-render ä¸€éã€‚

## å¯¹æ¯”

Suspense + use

```JavaScript
export default function Index() {
  const promise = getMessage()
  return (
    <Suspense fallback={<Skeleton />}>
      <Message promise={promise} />
    </Suspense>
  )
}
```

useEffect

```JavaScript
export default function Index() {
  const [content, update] = useState({value: ''})
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    getMessage().then(res => {
      update(res)
      setLoading(false)
    })
  }, []);

  if (loading) {
    return <Skeleton />
  }

  return (
    <Message message={content.value} />
  )
}
```

## åˆå§‹åŒ–ä¸è¯·æ±‚

é»˜è®¤ `promise` ä¸º `null`ï¼Œé€šè¿‡äº‹ä»¶æ›´æ–° promise çŠ¶æ€ã€‚

```JavaScript
import {use, useState, Suspense} from 'react'
import Message from './Message'
import Skeleton from './Skeleton'
import Button from './Button'
import {getMessage} from './api'

export default function Demo01() {
  const [promise, update] = useState(null)

  function __handler() {
    update(getMessage())
  }

  return (
    <>
      <div className='text-right mb-4'>
        <Button onClick={__handler}>æ›´æ–°æ•°æ®</Button>
      </div>
      <Suspense fallback={<Skeleton />}>
        <Content promise={promise} />
      </Suspense>
    </>
  )
}

function Content(props) {
  if (!props.promise) {
    return <Message message='' />
  }

  const {value} = use(props.promise)
  return (
    <Message message={value} />
  )
}
```

## åˆå§‹åŒ–è¯·æ±‚

åªéœ€è¦ç»™ promise ä¸€ä¸ªé»˜è®¤çš„åˆå§‹å€¼å³å¯ã€‚

```JavaScript
import {use, useState, Suspense} from 'react'
import Message from './Message'
import Skeleton from './Skeleton'
import Button from './Button'
import {getMessage} from './api'

export default function Demo02() {
  const [promise, update] = useState(getMessage())

  function __handler() {
    update(getMessage())
  }

  return (
    <>
      <div className='text-right mb-4'>
        <Button onClick={__handler}>æ›´æ–°æ•°æ®</Button>
      </div>
      <Suspense fallback={<Skeleton />}>
        <Content promise={promise} />
      </Suspense>
    </>
  )
}

function Content(props) {
  const {value} = use(props.promise)
  return (
    <Message message={value} />
  )
}
```

## åµŒå¥—

Suspense åµŒå¥—ä¼šå¯¼è‡´åç»­çš„è¯·æ±‚éƒ½ä¾èµ–å‰é¢çš„è¯·æ±‚ç»“æœã€‚

> æ²¡æœ‰ä¸¥æ ¼çš„å…ˆåé¡ºåºï¼Œæ²¡å¿…è¦åµŒå¥—ã€‚

# Ref

åœ¨ react 19 ä¸­ ref ç”±ç‹¬ç«‹çš„å‚æ•°å˜ä¸º props ä¸­çš„ä¸€å‘˜ã€‚

forwardRef è¢«æ— æƒ…å“ˆæ‹‰å°‘äº†ã€‚

> é€šå¸¸é€ä¼  ref çš„ä½œç”¨æ˜¯å°†è‡ªèº«çš„ä¸€äº›æ§åˆ¶æƒäº¤ç»™å¤–éƒ¨ï¼ˆä¹Ÿå¯æš´éœ²ä¸€äº›çŠ¶æ€ï¼‰ï¼Œä¹Ÿè¢«ç§°ä½œã€Œæ§åˆ¶åè½¬ã€ã€‚

```TypeScript
const Comp = (props) => {
  const {ref, ...others} = props;
  return <>xxx</>
}
```

# Context

åˆ›å»ºï¼š`Context.Provider` â†’ `Context`

è·å–ï¼š`useContext` â†’ `use`

æ—§ç‰ˆ

```TypeScript
import { createContext, useState, useContext } from 'react';

export const Context = createContext({});

export const Provider = (props: any) => {
  const [value, setValue] = useState({});
  return <Context.Provider value={{ value, setValue }}>{props.children}</Context.Provider>;
};

export const Comp = () => {
  const {value, setValue} = useContext(Context)
  return <>Comp</>;
};
```

æ–°ç‰ˆï¼ˆReact19ï¼‰

```TypeScript
import { createContext, useState, use } from 'react';

export const Context = createContext({});

export const Provider = (props: any) => {
  const [value, setValue] = useState({});
  return <Context value={{ value, setValue }}>{props.children}</Context>;
};

export const Comp = () => {
  const {value, setValue} = use(Context)
  return <>Comp</>;
};
```

# å¹¶å‘API

é™ä½ UI ä»»åŠ¡æ›´æ–°çš„ä¼˜å…ˆçº§ï¼ˆæ¨è¿ŸUIæ¸²æŸ“ä»»åŠ¡ï¼‰

1. useDeferredValue

    å…¶ä»–ä»»åŠ¡ä¼šä¸­æ–­å…¶çŠ¶æ€æ›´æ–°ã€‚

1. useTransition

    ä¸ä¼šä¸­æ–­å›è°ƒä¸­ä»»åŠ¡çš„æ‰§è¡Œï¼Œè€Œæ˜¯æ¨è¿ŸUIæ›´æ–°ã€‚ï¼ˆé€‚ç”¨äºä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼‰

## useDeferredValue

```TypeScript
export function useDeferredValue<T>(value: T): T;
```

æ¨è¿Ÿ UI çš„æ›´æ–°ï¼Œå°†å¯¹åº”ä»»åŠ¡çš„ä¼˜å…ˆçº§é™ä½ï¼Œä½¿å…¶å¯ä»¥è¢«æ’é˜Ÿä¸ä¸­æ–­ã€‚

è¿™é‡Œå°† useDeferredValue ä¼ é€’ç»™å­ç»„ä»¶ï¼ˆè€—æ—¶å­ç»„ä»¶ï¼‰ï¼Œå¯ä»¥å‘ç°æ­¤æ—¶ç¬¬äºŒä¸ª counter çš„æ›´æ–°å·²ç»è½åäº†ã€‚

ä½†æ˜¯å¿«é€Ÿç‚¹å‡»çš„æ—¶å€™ï¼Œæ˜æ˜¾ç¬¬ä¸€ä¸ª counter å·²ç»å‡ºç°å¡é¡¿ç°è±¡äº†ã€‚

å…¶å®å¾ˆç®€å•ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„æ¨¡æ‹Ÿæ¡ˆä¾‹ä¸­ï¼Œ**å¹¶æ²¡æœ‰æŠŠè€—æ—¶å®šä½åœ¨æ¸²æŸ“ä¸Š**ã€‚è¿™å°±å’Œå®é™…çš„æƒ…å†µä¸å¤ªä¸€æ ·äº†ã€‚æˆ‘ä»¬æŠŠè€—æ—¶å†™åœ¨äº† Expensive å‡½æ•°é‡Œï¼Œè€Œè¿™ä¸ªå‡½æ•°æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œå®ƒçš„æ‰§è¡Œé˜»å¡äº†æ¸²æŸ“ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šè§‰å¾—ç¬¬ä¸€ä¸ª counter çš„æ›´æ–°å˜å¾—æ¯”è¾ƒå¡é¡¿

```TypeScript
import {useState, useDeferredValue} from 'react'

export default function Index() {
  const [counter, setCounter] = useState(0)
  const deferred = useDeferredValue(counter, 0)

  function __clickHanler() {
    setCounter(counter + 1)
  }

  return (
    <div className='flex justify-between items-center'>
      <div>
        <div>counter: {counter}</div>
        <Expensive counter={deferred} />
      </div>
      <button onClick={__clickHanler}>counter++</button>
    </div>
  )
}

const Expensive = ({counter}) => {
  const start = performance.now()
  while (performance.now() - start < 200) {}
  return (
    <div className="mt-4">Deferred: {counter}</div>
  )
}
```

> æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¸€å®šè¦åŒºåˆ†å¼€**æ¸²æŸ“ä»»åŠ¡**å’Œ **Expensive** å‡½æ•°ï¼Œä»–ä»¬æ˜¯ä¸åŒçš„ï¼ŒUI æ¸²æŸ“æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œè€Œ Expensive å‡½æ•°æ˜¯**åŒæ­¥æ‰§è¡Œ**çš„ã€‚useDeferredValue æ¨è¿Ÿçš„æ˜¯ UI æ¸²æŸ“ä»»åŠ¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œä¸è¦åœ¨åŒæ­¥é€»è¾‘ä¸Šæ‰§è¡Œè¿‡å¤šçš„è€—æ—¶ä»»åŠ¡ã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»åŠ¡æ‹†åˆ†çš„æ–¹å¼ï¼ŒæŠŠæ‰§è¡Œè€—æ—¶æ—¶é—´åˆ†æ•£åˆ°æ›´å¤šçš„å­ç»„ä»¶ä¸­å»ï¼Œè¿™æ · React å°±å¯ä»¥åˆ©ç”¨ä»»åŠ¡ä¸­æ–­çš„æœºåˆ¶ï¼Œåœ¨ä¸é˜»å¡æ¸²æŸ“çš„æƒ…å†µä¸‹ï¼Œä¸­æ–­ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚

**ä¸‹æ¸¸ç»„ä»¶çš„ä»»åŠ¡ä¼˜å…ˆçº§ç›¸è¾ƒäºä¸Šæ¸¸ä¸€å®šæ˜¯æ›´ä½çš„ã€‚**

ä¸‹é¢ä¾‹å­ä¸­é‡‡ç”¨äº† React Complierï¼Œç»„ä»¶å‡æœ‰ç›¸åº”ç¼“å­˜ä¼˜åŒ–ã€‚

```TypeScript
import {useState, useDeferredValue} from 'react'

export default function Index() {
  const [counter, setCounter] = useState(0)
  const deferred = useDeferredValue(counter)

  function __clickHanler() {
    setCounter(counter + 1)
  }

  return (
    <div className='flex justify-between items-center'>
      <div>
        <div>counter: {counter}</div>
        <Expensive counter={deferred} />
      </div>
      <button onClick={__clickHanler}>counter++</button>
    </div>
  )
}

const Expensive = ({counter}) => {
  let items = []
  for (let i = 0; i < 200; i++) {
    items.push(<SlowItem key={i} counter={counter} />);
  }

  return (
    <div className='mt-4 text-green-500'>
      <div>Deferred: {counter}</div>
      <ul className='h-32 hidden'>
        {items}
      </ul>
    </div>
  );
}

function SlowItem({counter}) {
  let startTime = performance.now();
  while (performance.now() - startTime < 1) {
    // Do nothing for 1 ms per item to emulate extremely slow code
  }

  return (
    <li>{counter}</li>
  )
}
```

æ­¤æ—¶ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯ï¼Œcounter çš„ UI å˜åŒ–å˜å¾—æ›´åŠ æµç•…äº†ã€‚è¿™æ˜¯å› ä¸ºè€—æ—¶è¢«æ‹†åˆ†åˆ°äº†å¤šä¸ªå­ç»„ä»¶ä¸­ï¼ŒReact å°±æœ‰æœºä¼šä¸­æ–­è¿™äº›å‡½æ•°çš„æ‰§è¡Œï¼Œå¹¶æ‰§è¡Œä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼Œä»¥ç¡®ä¿é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„æµç•…ã€‚

å¦‚æœæ²¡æœ‰ä½¿ç”¨ React Complier ï¼Œåˆ™éœ€è¦å¯¹ Expensive ç»„ä»¶é€šè¿‡ memo åŒ…è£¹ï¼Œè¾¾åˆ°ç¼“å­˜æ•ˆæœã€‚

**å½“æ›´æ–°å‘ç”Ÿæ—¶ï¼ŒuseDefferdValue ä¼šé¦–å…ˆä½¿ç”¨æ—§å€¼ä¼ é€’ç»™ç»„ä»¶ã€‚**

å› æ­¤ï¼Œå½“ counter å‘ç”Ÿå˜åŒ–æ—¶ï¼Œdeferred ä¾ç„¶æ˜¯æ—§å€¼ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ memo åŒ…è£¹ï¼ŒExpensive çš„ props å°±æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡æ­¤æ¬¡é’ˆå¯¹ Expensive çš„æ›´æ–°ã€‚

æ‰€ä»¥å½“æˆ‘ä»¬å¿«é€Ÿç‚¹å‡»æ—¶ï¼ŒExpensive æ€»æ˜¯æ¥å—åˆ°æ—§å€¼ï¼Œå®ƒæœ¬èº«çš„æ¸²æŸ“ä¹Ÿä¼šè¢«ä¸­æ–­ï¼Œå› æ­¤æœ€ç»ˆçš„è¡¨ç°ç»“æœæ˜¯ï¼Œå½“æˆ‘ä»¬è¿ç»­ç‚¹å‡» 7 æ¬¡ï¼Œcounter ä» 0 ä¾æ¬¡å˜æˆ 7ï¼Œè€Œ deferred ä¼šç›´æ¥ä» 0 å˜æˆ 7ã€‚

### **è¿è¡ŒåŸç†**

useDeferredValue ä¼šå°è¯•å°† UI ä»»åŠ¡æ›´æ–°ä¸¤æ¬¡ã€‚



ç¬¬ä¸€æ¬¡ï¼Œä¼šç»™å­ç»„ä»¶ä¼ é€’æ—§å€¼ã€‚æ­¤æ—¶ `Expensive` æ¥æ”¶åˆ°çš„ props ä¼šä¸ä¸Šä¸€æ¬¡å®Œå…¨ç›¸åŒã€‚å¦‚æœç»“åˆäº† React.memoï¼Œé‚£ä¹ˆè¯¥ç»„ä»¶å°±ä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚è¯¥ç»„ä»¶å¯ä»¥é‡å¤ä½¿ç”¨ä¹‹å‰çš„æ¸²æŸ“ç»“æœ

> Compiler ç¼–è¯‘ä¹‹åä¸éœ€è¦ memo

æ­¤æ—¶ï¼Œé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ¸²æŸ“ä¼šå‘ç”Ÿï¼Œæ¸²æŸ“å®Œæˆä¹‹åï¼Œå°†ä¼šå¼€å§‹ç¬¬äºŒæ¬¡æ¸²æŸ“ã€‚æ­¤æ—¶ï¼Œå°†ä¼šä¼ å…¥åˆšæ‰æ›´æ–°ä¹‹åçš„æ–°å€¼ã€‚å¯¹äº `Expensive` è€Œè¨€ï¼Œprops å‘ç”Ÿäº†å˜åŒ–ï¼Œæ•´ä¸ªç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“ã€‚



æˆ‘ä»¬é€šå¸¸ä¼šå°†å·²ç»éå¸¸æ˜ç¡®çš„è€—æ—¶ä»»åŠ¡æ ‡è®°ä¸º deferredï¼Œå› æ­¤ï¼Œè¿™äº›ä»»åŠ¡éƒ½è¢«è§†ä¸ºä½ä¼˜å…ˆçº§ã€‚å½“é‡è¦çš„é«˜ä¼˜å…ˆçº§æ›´æ–°å·²ç»å®Œæˆï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡åœ¨ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶å°è¯•æ›´æ–°...

åœ¨å®ƒç¬¬äºŒæ¬¡æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåˆæœ‰æ–°çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡è¿›æ¥ï¼Œé‚£ä¹ˆ React å°±ä¼šä¸­æ–­å¹¶æ”¾å¼ƒç¬¬äºŒæ¬¡æ›´æ–°ï¼Œå»æ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚



è¿™æ ·çš„è¿è¡Œæœºåˆ¶æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å¥½å¤„ã€‚

é‚£å°±æ˜¯ï¼Œå¦‚æœä½ çš„ç”µè„‘æ€§èƒ½è¶³å¤Ÿå¼ºæ‚ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡çš„æ›´æ–°å¯èƒ½ä¼šå¿«é€Ÿå®Œæˆï¼Œé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ¥ä¸åŠä¸­æ–­ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„é¡µé¢å“åº”å°±æ˜¯éå¸¸ç†æƒ³çš„ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„ç”µè„‘æ€§èƒ½æ¯”è¾ƒå·®ï¼Œç¬¬äºŒæ¬¡æ›´æ–°è¿˜æ²¡å®Œæˆï¼Œæ–°çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡åˆæ¥äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ä¸­æ–­çš„æ–¹å¼ï¼Œé™çº§å¤„ç†ï¼Œä¿è¯é‡è¦ UI çš„æµç•…ï¼Œæ”¾å¼ƒä½ä¼˜å…ˆçº§ä»»åŠ¡ã€‚



## useTransition

ä¸ useDeferredValue ä¸€æ ·ï¼Œé™ä½ UI æ›´æ–°ä¼˜å…ˆçº§ï¼Œåªæ˜¯ç”¨æ³•ä¸ä¸€æ ·ã€‚

```TypeScript
export function useTransition(): [boolean, TransitionStartFunction];

const [isPending, startTransition] = useTransition()
```

`startTransition` å¯ä»¥æ ‡è®°ä¸€ä¸ªæˆ–è€…å¤šä¸ªçŠ¶æ€çš„ `set` æ–¹æ³•ï¼Œå°†ä»–ä»¬æ ‡è®°ä¸º `transition`ï¼Œä¹Ÿå°±æ˜¯è°ƒä½ä»–ä»¬æ›´æ–°çš„ä¼˜å…ˆçº§ã€‚

> ä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¢«è°ƒä½çš„ä¸æ˜¯ set æ–¹æ³•æœ¬èº«çš„æ‰§è¡Œï¼Œè€Œæ˜¯å…¶å¯¹åº”çš„ UI æ›´æ–°ã€‚

`isPending` è¡¨ç¤ºæ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„ UI æ›´æ–°ä»»åŠ¡ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªçŠ¶æ€æ¥åˆ¤æ–­è¯·æ±‚æ˜¯å¦æ­£åœ¨å‘ç”Ÿã€‚

å¯åŒæ—¶åŒ…è£¹å¤šä¸ª set ï¼ˆçŠ¶æ€çš„setæ–¹æ³•ï¼‰

```TypeScript
function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');
  const [other, setOther] = useState(false);

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);
      setOther(true)
    });
  }
  // ...
}
```

# Compiler

React Forget â†’ React Compiler

ç¼˜ç”±ï¼šçŠ¶æ€å˜æ›´ â†’ é¡¶å±‚å‘ä¸‹çš„æ›´æ–°æœºåˆ¶ â†’ å†—ä½™ re-render

> **å¯¹æ¯”çš„æˆæœ¬éå¸¸å°ï¼Œä½†æ˜¯ re-render çš„æˆæœ¬è¾ƒé«˜**

## ç¼–è¯‘å¯¹æ¯”

æºä»£ç 

```TypeScript
import {useState} from 'react'

export default function Counter() {
  const [count, setCount] = useState(0)

  function __clickHanler() {
    setCount(count + 1)
  }

  return (
    <div>
      <div>A Base Case</div>
      <div className="flex items-center justify-between">
        <div>currnt count is: {count}</div>
        <button onClick={__clickHanler}>Increment</button>
      </div>
    </div>
  )
}
```

compiler ç¼–è¯‘åï¼š

```TypeScript
import {useState} from 'react'
import Button from './Button'
import {_c} from './useCache.js'

export default function Counter() {
  const $ = _c(10);

  if ($[0] !== "a13b836c47c4cd480504d73b45661476522265776f255f2150833079731132ac") {
    for (let $i = 0; $i < 10; $i += 1) {
      $[$i] = Symbol.for("react.memo_cache_sentinel");
    }
    $[0] = "a13b836c47c4cd480504d73b45661476522265776f255f2150833079731132ac";
  }

  const [count, setCount] = useState(0);
  let t0;

  if ($[0] !== count) {
    t0 = function __clickHanler() {
      setCount(count + 1);
    };

    $[0] = count;
    $[1] = t0;
  } else {
    t0 = $[1];
  }

  const __clickHanler = t0;
  let t1;

  if ($[2] === Symbol.for("react.memo_cache_sentinel")) {
    t1 = <div>A Base Case</div>;
    $[2] = t1;
  } else {
    t1 = $[2];
  }

  let t2;

  if ($[3] !== count) {
    t2 = <div>currnt count is: {count}</div>;
    $[3] = count;
    $[4] = t2;
  } else {
    t2 = $[4];
  }

  let t3;

  if ($[5] !== __clickHanler) {
    t3 = <Button onClick={__clickHanler}>Increment</Button>;
    $[5] = __clickHanler;
    $[6] = t3;
  } else {
    t3 = $[6];
  }

  let t4;

  if ($[7] !== t2 || $[8] !== t3) {
    t4 = (
      <div>
        {t1}
        <div className="flex items-center justify-between">
          {t2}
          {t3}
        </div>
      </div>
    );
    $[7] = t2;
    $[8] = t3;
    $[9] = t4;
  } else {
    t4 = $[9];
  }

  return t4;
}
```

è¿™é‡Œå‡ºç°å¤§é‡ Symbol.forã€‚

> Symbol ä¹Ÿæ˜¯ç”¨æ¥åˆ›å»ºå…¨å±€å˜é‡çš„ï¼ŒSymbol.for ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä½†å…¶åˆ›å»ºé‡å¤ key çš„æ—¶å€™ä¼šèµ°ç¼“å­˜é‡Œé¢å»æ‹¿æ•°æ®ã€‚

```TypeScript
var a = Symbol.for('for')
var b = Symbol.for('for')

a === b // true

// åˆ›å»ºä¸€ä¸ª symbol å¹¶æ”¾å…¥ symbol æ³¨å†Œè¡¨ä¸­ï¼Œé”®ä¸º "foo"
Symbol.for("foo");

// ä» symbol æ³¨å†Œè¡¨ä¸­è¯»å–é”®ä¸º"foo"çš„ symbol
Symbol.for("foo"); 
```

å®é™…ä¸ŠåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å°†æ‰€æœ‰çš„è®¡ç®—ç»“æœéƒ½ç¼“å­˜ä¸‹æ¥ã€‚

æ³¨æ„è¿™é‡Œæœ€å t4 è¿™ä¸€æ®µï¼Œæ˜¯å°†åˆ†æ®µçš„ç¼“å­˜è¿›è¡Œæ•´åˆå¹¶è¿”å›ï¼Œç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæ²¡æœ‰å¯¹ t1 åšæ¡ä»¶åˆ¤æ–­ï¼ŒåŸå› åœ¨äº t1 æ¯”è¾ƒç¨³å®šï¼Œå¯ä»¥ç†è§£ä¸ºé™æ€èŠ‚ç‚¹ï¼Œè‡ªç„¶ compiler åœ¨è½¬è¯‘çš„è¿‡ç¨‹ä¸­è¿›è¡Œäº†ä¼˜åŒ–ã€‚

> 1ã€æˆ‘å¸Œæœ›é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œé¡µé¢æ¸²æŸ“æ›´å°‘çš„å†…å®¹ï¼Œå› æ­¤æ­¤æ—¶ï¼Œåªèƒ½å…ˆæ¸²æŸ“é»˜è®¤çš„ Panelã€‚å…¶ä»– Panel éœ€è¦åœ¨ç‚¹å‡»å¯¹åº”çš„æŒ‰é’®æ—¶ï¼Œæ‰æ¸²æŸ“å‡ºæ¥ã€‚

    2ã€åœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¸Œæœ›èƒ½å¤Ÿç¼“å­˜å·²ç»æ¸²æŸ“å¥½çš„ Panelï¼Œåªéœ€è¦åœ¨æ ·å¼ä¸Šåšéšè—ï¼Œè€Œä¸éœ€è¦åœ¨åç»­çš„äº¤äº’ä¸­é‡å¤æ¸²æŸ“å†…å®¹
    
    3ã€å½“å››ä¸ªé¡µé¢éƒ½æ¸²æŸ“å‡ºæ¥ä¹‹åï¼Œå†åšåˆ‡æ¢æ—¶ï¼Œæ­¤æ—¶åªä¼šæœ‰ä¸¤ä¸ªé¡µé¢ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸Šä¸€ä¸ªé€‰ä¸­çš„é¡µé¢ä¸ä¸‹ä¸€ä¸ªé€‰ä¸­çš„é¡µé¢ã€‚å¦å¤–çš„é¡µé¢ä¸å‚ä¸äº¤äº’ï¼Œåˆ™ä¸åº”è¯¥ re-renderã€‚

```TypeScript
import React, { useState } from 'react';

const Panel1 = () => {
  console.log('Rendering Panel 1');
  const [count, setCount] = useState(1);
  return <div onClick={() => setCount(count + 1)}>count1 {count}</div>;
};

const Panel2 = () => {
  console.log('Rendering Panel 2');
  const [count, setCount] = useState(1);
  return <div onClick={() => setCount(count + 1)}>count2 {count}</div>;
};

const Panel3 = () => {
  console.log('Rendering Panel 3');
  const [count, setCount] = useState(1);
  return <div onClick={() => setCount(count + 1)}>count3 {count}</div>;
};

const Panel4 = () => {
  console.log('Rendering Panel 4');
  const [count, setCount] = useState(1);
  return <div onClick={() => setCount(count + 1)}>count4 {count}</div>;
};

const App = () => {
  const items = [
    { id: 'Panel1', content: 'Panel 1', component: <Panel1 /> },
    { id: 'Panel2', content: 'Panel 2', component: <Panel2 /> },
    { id: 'Panel3', content: 'Panel 3', component: <Panel3 /> },
    { id: 'Panel4', content: 'Panel 4', component: <Panel4 /> },
  ];

  const [activePanel, setActivePanel] = useState('Panel1'); // å½“å‰é€‰ä¸­çš„ Panel
  const [renderedPanels, setRenderedPanels] = useState(['Panel1']); // ç¼“å­˜å·²æ¸²æŸ“çš„ Panel

  // å¤„ç† Panel åˆ‡æ¢
  const handlePanelClick = (panelId) => {
    setActivePanel(panelId);

    // å¦‚æœ Panel æ²¡æœ‰æ¸²æŸ“è¿‡ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°ç¼“å­˜ä¸­
    if (!renderedPanels.includes(panelId)) {
      setRenderedPanels([...renderedPanels, panelId]);
    }
  };

  return (
    <div>
      <div className="button-group">
        {items.map((item) => (
          <button className="mr-2" key={item.id} onClick={() => handlePanelClick(item.id)}>
            Show {item.content}
          </button>
        ))}
      </div>

      <div className="panel-container">
        {items.map((item) => (
          <div
            key={item.id}
            style={{
              display: activePanel === item.id ? 'block' : 'none',
            }}
          >
            {/* åªæœ‰å·²æ¸²æŸ“è¿‡çš„ Panel æ‰ä¼šæ˜¾ç¤ºå†…å®¹ */}
            {renderedPanels.includes(item.id) && item.component}
          </div>
        ))}
      </div>
    </div>
  );
};

export default App;
```

ä¸åŒäº Vue ç­‰æ¡†æ¶ï¼ŒReact ä¾ç„¶ä¸åš**ä¾èµ–æ”¶é›†**ã€‚

Compilerç¼–è¯‘ä¹‹åï¼Œä¼šå°†å‡ ä¹æ‰€æœ‰åº”è¯¥ç¼“å­˜çš„å…ƒç´ å’Œå‡½æ•°ç¼“å­˜èµ·æ¥ï¼Œå‘½ä¸­ç‡å¾ˆå¥½ã€‚

æœ€ç»ˆè¿˜æ˜¯é€šè¿‡è‡ªä¸Šè€Œä¸‹çš„ diff æ¥æ‰¾å‡ºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹ï¼Œè¿‡ç¨‹ä¸­å­˜åœ¨å¤§é‡çš„**åˆ¤æ–­**ã€‚

> å®é™…ä¸Šå¤§é‡çš„åˆ¤æ–­å¹¶ä¸è€—æ—¶

## æœ€ä½³å®è·µ

1. ä¸å†ä½¿ç”¨ useCallbackã€useMemoã€Memo ç­‰ç¼“å­˜å‡½æ•°

2. ä¸¢æ‰é—­åŒ…çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œæ”¾å¿ƒä½¿ç”¨å³å¯

3. å¼•å…¥ä¸¥æ ¼æ¨¡å¼

4. åœ¨ä½ ä¸ç†Ÿæ‚‰çš„æ—¶å€™å¼•å…¥ eslint-plugin-react-compiler

5. å½“ä½ ç†Ÿç»ƒä¹‹åï¼Œå¼ƒç”¨å®ƒï¼Œå› ä¸ºæœ‰çš„æ—¶å€™æˆ‘ä»¬å°±æ˜¯ä¸æƒ³è®©å®ƒç¼–è¯‘æˆ‘ä»¬çš„ç»„ä»¶

6. æ›´å¤šçš„ä½¿ç”¨ use ä¸ Action æ¥å¤„ç†å¼‚æ­¥é€»è¾‘

7. å°½å¯èƒ½å°‘çš„ä½¿ç”¨ useEffect

å½“ä½ ä¸å¸Œæœ›ä½ çš„ç»„ä»¶è¢« Compiler ç¼–è¯‘çš„æ—¶å€™ï¼Œåªéœ€è¦é€šè¿‡ var å®šä¹‰çŠ¶æ€å³å¯ã€‚

var [counter, setCounter] = useState(0)

å› ä¸ºè¿™ä¸ç¬¦åˆå®ƒçš„è¯­æ³•è§„èŒƒã€‚

### ä¼˜åŒ–è€—æ—¶ç»„ä»¶

```TypeScript
import { useState } from 'react'

function App() {
  var [counter, setCounter] = useState(0)

  function __clickHanler() {
    setCounter(counter + 1)
  }

  return (
    <div>
      <div>A Expensive Case</div>
      <div className="flex items-center justify-between mt-4">
        <div className="counter">current counter is: {counter}</div>
        <button onClick={__clickHanler}>counter++</button>
      </div>
      <Expensive/>
    </div>
  )
}

export default App


function Expensive() {
  var cur = performance.now()
  while (performance.now() - cur < 100) {
    // block 100ms
  }

  return (
    <div className='border border-red-500 rounded p-4 mt-4 text-red-500 text-sm leading-6'>
      è¿™æ˜¯æ¨¡æ‹Ÿçš„ä¸€ä¸ªè€—æ—¶å­ç»„ä»¶ï¼Œæˆ‘çš„æ¸²æŸ“è‡³å°‘è¦æŸè€— 100ms çš„æ—¶é—´ï¼Œå› æ­¤å¦‚æœä¸åšä»»ä½•ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œå½“ä½ å¿«é€Ÿç‚¹å‡»æŒ‰é’®æ—¶ï¼Œä½ ä¼šæ„Ÿå—åˆ° counter çš„é€’å¢ä¼šæœ‰æ˜æ˜¾çš„æ‰å¸§ã€‚
    </div>
  )
}
```

Compiler å¯¹äºè€—æ—¶ç»„ä»¶ç¼–è¯‘åç»“æœï¼š

```TypeScript
let t5;

if ($[10] === Symbol.for("react.memo_cache_sentinel")) {
  t5 = <Expensive />;
  $[10] = t5;
} else {
  t5 = $[10];
}
```

ç”±äºæ²¡æœ‰ä¾èµ–ä»»ä½•çŠ¶æ€ï¼Œå½“ä½œé™æ€èŠ‚ç‚¹ç¼“å­˜ã€‚

Butï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¾ˆå°‘æœ‰è¿™ä¹ˆç‹¬ç«‹çš„ä¸ªä½“å­˜åœ¨ã€‚

# æ¶æ„æ€ç»´

## ç»„ä»¶åŒ–å†…èš

æ‰€è°“ç»„ä»¶å…§èšï¼Œå³æ‰€æœ‰ç»„ä»¶æ‰€éœ€éƒ½é›†ä¸­ç»„ç»‡ï¼Œé«˜è€¦åˆç»“æ„ã€‚

```Plain Text
+ pages
  + home
    - index.tsx
    - index.d.ts
    - index.css
    - api.ts
    - model.ts   // Modal æ•°æ®å±‚
    + components // å¯èƒ½å­˜åœ¨çš„å­ç»„ä»¶
```

## MVC ã€ŒModel View Controllerã€

å¸¸æåŠçš„ä¸äºˆå¤šä½™ä»‹ç»ã€‚

## BBFã€ŒBackend For Frontendã€

é€šå¸¸æƒ…å†µä¸‹æŒ‡çš„æ˜¯åœ¨å‰ç«¯ä¸åç«¯ä¹‹é—´è®¾è®¡ä¸€ä¸ª**ä¸­é—´å±‚**ï¼Œç”¨äºå¤„ç†å‰åç«¯ä¹‹é—´æ•°æ®çš„å·®å¼‚ã€‚

æ¯”è¾ƒå¥½çš„åšæ³•å°±æ˜¯åœ¨å‰åç«¯ä¹‹é—´åšä¸€ä¸ª node ä¸­é—´å±‚ï¼Œæ¥å°†å¯¹æ•°æ®å¤„ç†ä»å‰ç«¯é¡µé¢å‰¥ç¦»å‡ºå»ã€‚

ğŸ¥šæ˜¯ï¼Œä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

1. æ²Ÿé€šæˆæœ¬é«˜

2. ç»´æŠ¤æˆæœ¬é«˜

3. å‰ç«¯è¾¹ç¼˜åŒ–

4. çµæ´»æ€§ä¸è¶³

å› æ­¤ï¼Œé€šå¸¸æˆ‘ä»¬é‡‡ç”¨ MVC + BBF çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨å‰ç«¯è‡ªå·±æ„å»ºä¸€å±‚ Cotroller å±‚ã€‚

`Controller` å±‚é€šå¸¸ç”¨äºå¤„ç†ä»¥ä¸‹é€»è¾‘ï¼š

1. éªŒè¯æ•°æ®å­—æ®µå†…å®¹ä¸ç±»å‹æ˜¯å¦ç¬¦åˆé¢„æœŸ

2. éªŒè¯å®‰å…¨æ€§ç­‰å…¶ä»–é¢å¤–é€»è¾‘

3. äºŒæ¬¡å¤„ç†ï¼Œæ•´ç†æˆä¸ºåº”ç”¨å±‚éœ€è¦çš„ç»“æ„

æœ€ç»ˆçš„ç›®çš„è¿˜æ˜¯ç¡®ä¿**æ•°æ®æ˜¯å”¯ä¸€æ¥æºä¸”å³æ‹¿å³ç”¨**ã€‚

> æ•°æ®æ ¡éªŒå¯é€šè¿‡ Zod å®ç°ã€‚

## ç»„ä»¶æ‹†åˆ†åŸåˆ™

1. æ€»åˆ†æ€»åŸåˆ™

2. æ‹†åˆ†ç›®çš„ï¼šæé«˜å¯è¯»æ€§å’Œç»´æŠ¤æ€§

3. æ‹†åˆ†å•ä½ï¼šéœ€è¦èƒ½æç‚¼å‡ºæ˜ç¡®çš„è¯­ä¹‰

4. å¼‚æ­¥ç»„ä»¶åŸºç¡€æ ‡å‡†ï¼šLoading ä¸ ç»„ä»¶æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»

> åˆšå¼€å§‹ï¼Œå¦‚æœä½ è¿˜æ— æ³•æŠŠæ§æ˜¯å¦å¤æ‚çš„å…·ä½“ç²’åº¦ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„è§„å®šæ¥çº¦æŸï¼šä¸€ä¸ªæ–‡ä»¶çš„ä»£ç ä¸èƒ½è¶…è¿‡ 200 è¡Œï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œå°±éœ€è¦è€ƒè™‘æ‹†åˆ†

# å®æˆ˜

## æµå¼æ¸²æŸ“

åˆ©ç”¨ Suspense åµŒå¥—å®ç°ã€‚

## å¤šæ¥å£å¹¶è¡Œ

é€šè¿‡è‡ªå®šä¹‰ Controller å±‚ï¼ŒPromise.all å®ç°ã€‚
