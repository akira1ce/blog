---
title: React æ ¸å¿ƒåŸç†è¿›é˜¶
category: ['Notes']
slug: notes-react-core-bobo
date: 2024-10-22
summary: æ·±å…¥å‰–æ React æºç ç»“æ„ä¸æ ¸å¿ƒåŸç†ï¼Œå¸®åŠ©ç†è§£æ¡†æ¶è®¾è®¡ä¸å®ç°ç»†èŠ‚ã€‚
---


# å¹¶å‘

æ—©æœŸå•çº¿ç¨‹ -> **æ—¶é—´åˆ‡ç‰‡** -> å¿«é€Ÿä»»åŠ¡åˆ‡æ¢ ->  **å¹¶å‘æ¨¡å¼**

éšç€ç¡¬ä»¶çš„é©æ–° -> å¤šæ ¸CPU -> å¤šä»»åŠ¡æ‰§è¡Œ -> **å¹¶è¡Œ**

è€Œå¹¶å‘æ¨¡å¼çš„å«ä¹‰ï¼Œä¹Ÿéšç€å‘ç°äº†ä¸€äº›è½¬å˜ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬æŠŠ**å¤šä¸ªæ‰§è¡Œå•ä½ï¼Œå¯¹å•ä¸€æ‰§è¡Œèµ„æºçš„ç«äº‰ï¼Œå«åšå¹¶å‘**ã€‚

åœ¨ç«äº‰çš„è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†ç¡®ä¿ä¸å‘ç”Ÿæ‹¥å µï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥**è°ƒåº¦æœºåˆ¶**ã€‚

æ‰€è°“è°ƒåº¦ï¼Œå®é™…ä¸Šæ˜¯å¯¹äºä»»åŠ¡æŒ‰ç…§æŸç§æœºåˆ¶è¿›è¡Œæ’åºï¼Œæ¯”å¦‚ä¼˜å…ˆçº§ï¼Œæ¥è¾¾åˆ°æ’é˜Ÿã€ä¸­æ–­çš„æ•ˆæœã€‚

> å‰ç«¯å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¾ˆå°‘èƒ½é‡åˆ°å¹¶å‘çš„é—®é¢˜ï¼Œå‡ºç°å°±è¯´æ˜è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„åœºæ™¯ï¼Œå­˜åœ¨è®¸å¤š**é•¿è€—æ—¶ä»»åŠ¡ä»»åŠ¡é˜»å¡æ¸²æŸ“**

**ä»»åŠ¡ä¸­æ–­**

js å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸å¯ä¸­æ–­ï¼Œä»»ä¸€ä¸Šä¸‹æ–‡çš„æ‰§è¡Œè¿‡ç¨‹éƒ½æ˜¯ä¸å¯ä¸­æ–­çš„ã€‚

å®ç°å¯ä¸­æ–­çš„æ–¹å¼åªæœ‰ä¸€ä¸ªï¼š**ä»»åŠ¡æ‹†åˆ†** -> **å¾ªç¯/é€’å½’**

# ä»»åŠ¡ & é˜Ÿåˆ—

é€’å½’çš„è¿‡ç¨‹ä¸€å®šæ˜¯åœ¨é€’å½’ä»»åŠ¡é˜Ÿåˆ—çš„ã€‚

react ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼š

1. ä¸´æ—¶é˜Ÿåˆ—
2. ä»»åŠ¡é˜Ÿåˆ—

**ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ === å®Œæ•´ä¸€æ¬¡æ›´æ–°**

é€šè¿‡ scheduleCallback æ–¹æ³•è¿›è¡Œå…¥é˜Ÿæ“ä½œï¼Œå®é™…ä¸Šè¿›å…¥é˜Ÿåˆ—çš„å‡½æ•°å°±æ˜¯ **performWorkOnRootViaSchedulerTask**ï¼Œè¿™ä¸ªå‡½æ•°ä½œç”¨å°±æ˜¯æ‰§è¡Œ fiber èŠ‚ç‚¹çš„ diff æ›´æ–°æ“ä½œã€‚

**è€Œ React çš„ä¸€æ¬¡æ›´æ–°ï¼Œæ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå‘ä¸‹é€’å½’å¯¹æ¯”çš„è¿‡ç¨‹ã€‚**

```js
// å£°æ˜ä¸€ä¸ªçŠ¶æ€
const [counter, setCounter] = useState(0);
```

setCounter -> dispatchSetState -> ... -> scheduleCallback

set æ–¹æ³•å¯ä»¥çœ‹åšä»»åŠ¡è§¦å‘å™¨ï¼Œå®ƒæ‰€å¯¹åº”çš„è¦æ‰§è¡Œçš„ä»»åŠ¡é€»è¾‘ï¼Œæ˜¯ä¸€æ¬¡å®Œæ•´çš„æ›´æ–°è¿‡ç¨‹ã€‚

**set ä¹‹åè°ƒç”¨é“¾è·¯ï¼š**

```
dispatchSetState -> ã€Œè§¦å‘çŠ¶æ€æ›´æ–°ã€
dispatchSetStateInternal ->  ã€Œå°†æ›´æ–°å†…å®¹åˆå¹¶æˆ update å¯¹è±¡ï¼ŒæŒ‚è½½åˆ° fiber ä¸Šã€
scheduleUpdateOnFiber -> ã€Œç¡®å®šæ˜¯å¦éœ€è¦è§¦å‘è°ƒåº¦å™¨è¿›è¡ŒçŠ¶æ€æ›´æ–°ã€
ensureRootIsScheduled -> ã€Œç¡®ä¿æŸä¸ªæ ¹èŠ‚ç‚¹çš„æ›´æ–°ä»»åŠ¡å·²ç»è¢«è°ƒåº¦ï¼Œå¹¶ä¼šå°†æ›´æ–°ä»»åŠ¡æ¨é€åˆ°è°ƒåº¦é˜Ÿåˆ— - é€šçŸ¥æ ¹èŠ‚ç‚¹æœ‰ä¸€ä¸ªæ›´æ–°äº§ç”Ÿã€
scheduleImmediateTask ->
processRootScheduleInMicrotask ->
scheduleTaskForRootDuringMicrotask -> ã€Œè½¬æ¢ä¼˜å…ˆçº§ã€
scheduleCallback(schedulerPriorityLevel, schedulerPriorityLevel, performWorkOnRootViaSchedulerTask.bind(null, root)) -> ã€Œå°†æ›´æ–°ä»»åŠ¡æ¨é€åˆ°ä»»åŠ¡é˜Ÿåˆ— & å¼€å§‹å¾ªç¯ä»»åŠ¡é˜Ÿåˆ—ã€
performWorkOnRoot -> renderRootSync -> workLoopSync / renderRootConcurrent -> workLoopConcurrent - ã€Œå¾ªç¯ fiber é“¾è¡¨ diff è¿‡ç¨‹ã€
```

# ensureRootIsScheduled & ä»»åŠ¡åˆå¹¶

ä¸€è½®äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ª setter çš„è°ƒç”¨ï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡ setter å¯¹åº”ä¸€ä¸ªå®Œæ•´çš„ diff è¿‡ç¨‹ï¼Ÿ

æ˜¾ç„¶ react ä¸å¯èƒ½è¿™ä¹ˆå¤„ç†çš„ã€‚

```js
// Used to prevent redundant mircotasks from being scheduled.
let didScheduleMicrotask: boolean = false;

if (!didScheduleMicrotask) {
  didScheduleMicrotask = true;
  scheduleImmediateTask(processRootScheduleInMicrotask);
}
```

å®ƒåœ¨è¯­ä¹‰ä¸Šçš„æ„æ€æ˜¯**ç¡®ä¿æ ¹èŠ‚ç‚¹çš„æ›´æ–°ä»»åŠ¡è¢«è°ƒåº¦**ï¼Œé€šä¿—çš„è¯´æ˜¯é€šçŸ¥æ ¹èŠ‚ç‚¹æœ‰æ›´æ–°ï¼Œå®é™…ä¸Šåœ¨åº•å±‚è§¦å‘çš„ä¸€ä¸ª **promise** ä»»åŠ¡ã€‚

æ ¸å¿ƒä½œç”¨åœ¨äº**åˆå¹¶**å¤šæ¬¡æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯**æ‰¹å¤„ç†**ã€‚


**ä»€ä¹ˆæ—¶å€™ä¼šè¢«è°ƒç”¨ï¼š**

1. å½“ç»„ä»¶è°ƒç”¨ setState æˆ–ä½¿ç”¨ hooks è¿›è¡ŒçŠ¶æ€æ›´æ–°æ—¶
2. å½“æœ‰æ–°çš„ props ä¼ å…¥æ—¶
3. å½“ context å‘ç”Ÿå˜åŒ–æ—¶
4. å½“æœ‰æ‰‹åŠ¿äº¤äº’æ—¶ï¼ˆé€šè¿‡ scheduleGesture å‡½æ•°ï¼‰
5. å½“æœ‰è¿‡æ¸¡åŠ¨ç”»éœ€è¦å¤„ç†æ—¶
6. åœ¨äº‹ä»¶å¤„ç†å®Œæˆåï¼Œéœ€è¦æ›´æ–° DOM æ—¶
7. åœ¨æ‰¹é‡æ›´æ–°ç»“æŸæ—¶

```js
setCounter()
setCounter()
setCounter()
setCounter()
```

æ¯ä¸€ä¸ª setCounter æœ€ç»ˆå¯¹åº”çš„æ˜¯ä¸€æ¬¡è‡ªé¡¶å‘ä¸‹çš„å®Œæ•´çš„ diff æ›´æ–°è¿‡ç¨‹ã€‚å¦‚æœä¸è¿›è¡Œåˆå¹¶ï¼Œä¼šå­˜å·¨å¤§çš„æ€§èƒ½é—®é¢˜ã€‚

å› æ­¤åœ¨è¿›å…¥ taskQueue ã€Œä»»åŠ¡é˜Ÿåˆ—ã€ä¹‹å‰è¿˜è¦è¿›è¡Œåˆå¹¶ã€‚

setter x N -> microQueue -> taskqueue

> ä¸ºä»€ä¹ˆæ˜¯å¾®ä»»åŠ¡ï¼Ÿ
>
> è¦åˆå¹¶å¤šä¸ª setCounterï¼Œåˆ™éœ€è¦åˆå¹¶é€»è¾‘å°½é‡åœ¨æœ€åä¸€ä¸ª setCounter ä¹‹åã€‚å‰é¢éƒ½æ˜¯è¿›å…¥é˜Ÿåˆ—è¿›è¡Œæ”¶é›†ç­‰å¾…ã€‚ä½†æ˜¯å› ä¸ºæˆ‘ä»¬å¹¶ä¸çŸ¥é“åœ¨ä¸€è½®å‡½æ•°è°ƒç”¨æ ˆä¸­ï¼Œæœ€åä¸€ä¸ª setCounter åˆ°åº•æ˜¯å“ªä¸€ä¸ªã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥éå¸¸ç¡®å®šçš„çŸ¥é“ï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯åœ¨å‡½æ•°è°ƒç”¨æ ˆæ¸…ç©ºä¹‹åæ‰å¼€å§‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ä¸€ä¸ªéå¸¸é€‚åˆçš„æ—¶æœºã€‚

æ¯æ¬¡ setter ä¹‹åæ‰§è¡Œ dispatchSetStateInternalï¼Œä¼šæŠŠæ›´æ–°å†…å®¹åˆå¹¶åˆ° update å¯¹è±¡ï¼Œæœ€ç»ˆæŒ‚è½½åˆ° fiber ä¸Šã€‚

**æ‰¹å¤„ç†çš„æ ¸å¿ƒ**å°±æ˜¯ï¼Œå¤šæ¬¡ä¿å­˜æ›´æ–°çš„æ•°æ®ï¼Œè¿™äº›æ›´æ–°æ•°æ®ä¼šç»„æˆä¸€ä¸ª**é“¾è¡¨**ï¼Œç„¶åä¸€æ¬¡æ€§ç»Ÿä¸€å¤„ç†ã€‚

**æ€»ç»“**

react ä¸­ï¼Œä¾èµ–äº**äº‹ä»¶å¾ªç¯**æœºåˆ¶ï¼Œä¹Ÿåˆ†åˆ«å®šä¹‰äº†è‡ªå·±çš„å®ä»»åŠ¡é˜Ÿåˆ—ä¸å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚åˆ©ç”¨**å¾®ä»»åŠ¡é˜Ÿåˆ—åˆå¹¶å¤šæ¬¡ ensureRootIsScheduled çš„é€šçŸ¥**ï¼Œä»è€Œå‡å°‘äº†å¤šæ¬¡ **diff** æ›´æ–°ã€‚

å®ä»»åŠ¡é˜Ÿåˆ—åˆ™æ˜¯å¯åŠ¨**æ›´æ–°ä»»åŠ¡**ï¼Œå…¶å¯¹åº”çš„æ˜¯æ•´ä¸ª diff æ›´æ–°çš„æ¸²æŸ“è¿‡ç¨‹ã€‚

# scheduleCallback

```js
function unstable_scheduleCallback(
  /* ä»»åŠ¡ä¼˜å…ˆçº§ */
  priorityLevel: PriorityLevel,
  /* ä»»åŠ¡å›è°ƒ */
  callback: Callback,
  options?: {delay: number},
): Task {
  // ...
}
```

ä»»åŠ¡å…¥é˜Ÿ & å¯åŠ¨ä¸€è½®å¾ªç¯ã€‚

åœ¨ä¸€è½®å¾ªç¯ä¸­ scheduleCallback ä¸­åªä¼šè°ƒç”¨ä¸€æ¬¡ schedulePerformWorkUntilDeadlineã€‚é€šè¿‡å…¨å±€å˜é‡ isMessageLoopRunning æ§åˆ¶ï¼Œå¼€å¯å¾ªç¯ä¹‹åå¯èƒ½è¿˜ä¼šå…¥é˜Ÿä»»åŠ¡ã€‚

## è°ƒç”¨é“¾è·¯

scheduleCallback -> ã€Œå°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ— & å¼€å¯å¾ªç¯é˜Ÿåˆ—ã€
requestHostCallback -> schedulePerformWorkUntilDeadline -> ã€Œç±»ä¼¼settimeout(performWorkUntilDeadline, 0)ï¼Œå¼€å¯å¾ªç¯ã€
performWorkUntilDeadline -> flushwork -> workloop ã€Œå¼€å§‹é€’å½’ä»»åŠ¡ã€

```js
function requestHostCallback() {
  /* æ˜¯å¦å·²ç»å¼€å§‹å¾ªç¯ä»»åŠ¡ */
  if (!isMessageLoopRunning) {
    isMessageLoopRunning = true;
    /* å¯¹å®šæ—¶å™¨çš„å°è£… */
    schedulePerformWorkUntilDeadline();
  }
}

/* ç±»ä¼¼ settimeout(performWorkUntilDeadline, 0) -> å®ä»»åŠ¡ä¸­å¼€å§‹å¾ªç¯ä»»åŠ¡é˜Ÿåˆ— */
let schedulePerformWorkUntilDeadline;
if (typeof localSetImmediate === 'function') {
  // Node.js æˆ–è€… è€ç‰ˆæœ¬çš„ IE
  schedulePerformWorkUntilDeadline = () => {
    localSetImmediate(performWorkUntilDeadline);
  };
} else if (typeof MessageChannel !== 'undefined') {
  // DOM and Worker environments.
  // We prefer MessageChannel because of the 4ms setTimeout clamping.
  const channel = new MessageChannel();
  const port = channel.port2;
  channel.port1.onmessage = performWorkUntilDeadline;
  schedulePerformWorkUntilDeadline = () => {
    port.postMessage(null);
  };
} else {
  schedulePerformWorkUntilDeadline = () => {
    localSetTimeout(performWorkUntilDeadline, 0);
  };
}

/* flushwork -> workloop -> while taskQueue */
const performWorkUntilDeadline = () => {
  if (isMessageLoopRunning) {
    const currentTime = getCurrentTime();
    /* è®°å½•å¾ªç¯å¼€å§‹æ—¶é—´ */
    startTime = currentTime;

    let hasMoreWork = true;
    try {
      /* å¾ªç¯è¿‡ç¨‹å¯èƒ½è¿˜åœ¨è°ƒç”¨ scheduleCallback push ä»»åŠ¡ */
      hasMoreWork = flushWork(currentTime);
    } finally {
      if (hasMoreWork) {
        /* è¿˜æœ‰ä»»åŠ¡ç»§ç»­å¾ªç¯ */
        schedulePerformWorkUntilDeadline();
      } else {
        isMessageLoopRunning = false;
      }
    }
  }
};
```

## schedulePerformWorkUntilDeadline

schedulePerformWorkUntilDeadline -> performWorkUntilDeadline

ç±»ä¼¼ä¸ settimeout(performWorkUntilDeadline, 0)ï¼Œå¯åŠ¨å®ä»»åŠ¡å¼€å¯å¾ªç¯ä»»åŠ¡é˜Ÿåˆ—ï¼ŒperformWorkUntilDeadline ä¼šè°ƒç”¨ flushwork & workloop å‡½æ•°ï¼Œæ¥éå† task-queueã€‚

schedulePerformWorkUntilDeadline æ˜¯å¼€å¯å®ä»»åŠ¡ï¼Œæ¯æ¬¡æ‰§è¡Œä¼šåŠ å…¥åˆ°å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œåœ¨ä¸‹ä¸€äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œã€‚

**æ³¨æ„ performWorkUntilDeadline å¯èƒ½è¢«ä¸­æ–­ï¼Œç„¶åé‡æ–°é€’å½’è°ƒç”¨ schedulePerformWorkUntilDeadlineï¼Œç»§ç»­å¾ªç¯ã€‚**

schedulePerformWorkUntilDeadline -> performWorkUntilDeadline -> yield -> schedulePerformWorkUntilDeadline

## workLoop

å¾ªç¯ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œä»»åŠ¡å›è°ƒï¼Œä»»åŠ¡æ¥è‡ªäº `scheduleCallback(performWorkOnRootViaSchedulerTask)`ã€‚

performWorkOnRootViaSchedulerTask -> performWorkOnRoot -> renderRootConcurrent -> workLoopConcurrent

workLoopConcurrent å®é™…ä¸Šå°±æ˜¯åœ¨å¾ªç¯ fiber é“¾è¡¨

```js
function workLoop(initialTime: number) {
  let currentTime = initialTime;
  /* éå†ä¸´æ—¶é˜Ÿåˆ— timerQueue */
  advanceTimers(currentTime);
  /* å–å †é¡¶ä»»åŠ¡ */
  currentTask = peek(taskQueue);

  while (currentTask !== null) {
    /* æ£€æŸ¥æ˜¯å¦éœ€è¦è®©å‡ºä¸»çº¿ç¨‹ */
    if (!enableAlwaysYieldScheduler) {
      if (currentTask.expirationTime > currentTime && shouldYieldToHost()) {
        break;
      }
    }

    // æ‰§è¡Œå›è°ƒ
    const callback = currentTask.callback;
    if (typeof callback === 'function') {
      currentTask.callback = null;
      currentPriorityLevel = currentTask.priorityLevel;
      const didUserCallbackTimeout = currentTask.expirationTime <= currentTime;

      /**
       * æ‰§è¡Œä»»åŠ¡å›è°ƒ
       * è¿™é‡Œçš„è¿”å›å€¼å®é™…ä¸Šä¹Ÿæ˜¯ callbackï¼Œæ˜¯å› ä¸ºåœ¨å¾ªç¯ fiber é“¾è¡¨çš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šä¸­æ–­ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è®°å½•ä¸‹æ¥ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ‰§è¡Œ
      */
      const continuationCallback = callback(didUserCallbackTimeout);

      // å¤„ç†ä»»åŠ¡ç»“æœ
      if (typeof continuationCallback === 'function') {
        currentTask.callback = continuationCallback;
        return true; // è¿˜æœ‰å·¥ä½œè¦åš - é‡æ–°å…¥é˜Ÿ
      }
    }

    /* å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ */
    currentTask = peek(taskQueue);
  }

  // è¿”å›æ˜¯å¦è¿˜æœ‰å‰©ä½™ä»»åŠ¡
  return currentTask !== null;
}

/**
 * 1. æ¸…ç†æ‰è¢«å–æ¶ˆçš„å»¶è¿Ÿä»»åŠ¡
 * 2. å°†ç¬¦åˆæ‰§è¡Œæ¡ä»¶çš„ä»»åŠ¡æ¢ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ— timerQueue -> taskQueue
*/
function advanceTimers(currentTime: number) {
  // Check for tasks that are no longer delayed and add them to the queue.
  let timer = peek(timerQueue);
  while (timer !== null) {
    /* ç§»é™¤å·²å–æ¶ˆçš„ä»»åŠ¡ */
    if (timer.callback === null) {
      pop(timerQueue);
    } else if (timer.startTime <= currentTime) {
      // Timer fired. Transfer to the task queue.
      pop(timerQueue);
      timer.sortIndex = timer.expirationTime;
      push(taskQueue, timer);
      if (enableProfiling) {
        markTaskStart(timer, currentTime);
        timer.isQueued = true;
      }
    } else {
      // Remaining timers are pending.
      return;
    }
    timer = peek(timerQueue);
  }
}
```

# æ—¶é—´åˆ‡ç‰‡

React åŸºäºäº‹ä»¶å¾ªç¯å®ç°äº†

1. å¾®ä»»åŠ¡ scheduleImmediateTask åˆå¹¶å¤šä¸ªæ›´æ–°è§¦å‘
2. å®ä»»åŠ¡ scheduleCallback å¯åŠ¨ taskQueue é˜Ÿåˆ—

å¾®ä»»åŠ¡å±‚é¢å®é™…ä¸Šä¸å— react æ§åˆ¶ï¼Œæ‰€ä»¥åªèƒ½åœ¨å®ä»»åŠ¡ã€ŒtaskQueueã€ä¸­å®ç°æ—¶é—´åˆ‡ç‰‡ã€‚

å…¶ä¸­ shouldYield å°±æ˜¯ä¸­æ–­æ¡ä»¶ã€‚

## shouldYield

react å†…éƒ¨å¾ªç¯ä¸­æ–­æ¡ä»¶ï¼Œåˆ¤æ–­å½“å‰ä¸€è½®å¾ªç¯æ˜¯å¦è¶…è¿‡ä¸€å¸§ã€Œreact å†…éƒ¨å®šä¹‰å¸§ - frameIntervalã€

```js
/* React å†…éƒ¨ç»´æŠ¤çš„ä»»åŠ¡é˜Ÿåˆ—å¼€å§‹å¾ªç¯çš„æ—¶é—´ */
let startTime = -1;

function shouldYieldToHost(): boolean {
  const timeElapsed = getCurrentTime() - startTime;
  /* frameInterval - å†…éƒ¨ä¸€å¸§çš„æ—¶é—´ã€Œé»˜è®¤ 5msã€æ—¶é—´åˆ‡ç‰‡ */
  if (timeElapsed < frameInterval) {
    return false;
  }
  return true;
}
```

## å¤–å±‚å¾ªç¯ - schedulePerformWorkUntilDeadline

å¤–å±‚é€šè¿‡é€’å½’è°ƒç”¨ [schedulePerformWorkUntilDeadline](#schedulePerformWorkUntilDeadline)ï¼Œæ¥å¯åŠ¨ flushWork -> workLoopã€‚

```js
const performWorkUntilDeadline = () => {
  if (isMessageLoopRunning) {
    const currentTime = getCurrentTime();
    startTime = currentTime;
    let hasMoreWork = true;
    try {
      /* æ˜¯å¦è¿˜æœ‰å‰©ä½™ä»»åŠ¡ */
      hasMoreWork = flushWork(currentTime);
    } finally {
      if (hasMoreWork) {
        /* ç»§ç»­é€’å½’ - settimeout ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼Œå¦‚æ­¤å°±å¯ä»¥è®©æœ‰äº›ä»»åŠ¡å®ç°æ’é˜Ÿ */
        schedulePerformWorkUntilDeadline();
      } else {
        isMessageLoopRunning = false;
      }
    }
  }
};
```

schedulePerformWorkUntilDeadline -> performWorkUntilDeadline -> flushWork -> workLoop --\{maybe shouldYield}-> schedulePerformWorkUntilDeadline

flushWork -> workLoop å¯èƒ½å­˜åœ¨ä¸­æ–­ï¼Œä¼šè¿”å›æ˜¯å¦è¿˜æœ‰å‰©ä½™ä»»åŠ¡æ ‡è¯†ï¼Œå­˜åœ¨å‰©ä½™ä»»åŠ¡åˆ™ç»§ç»­é€’å½’è°ƒç”¨ schedulePerformWorkUntilDeadline

**å®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœäº§ç”Ÿäº†æ–°çš„ä»»åŠ¡ï¼Œä¼šæ¨å…¥åˆ°ä¸´æ—¶é˜Ÿåˆ—ä¸­ç”±ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯æ‰§è¡Œã€‚**

å› æ­¤ï¼Œæ–°çš„æ›´æ–°ä»»åŠ¡ setXxxx ä¾¿æœ‰äº†æ’é˜Ÿçš„å¯èƒ½æ€§ã€‚åªè¦ä¼˜å…ˆçº§å¤Ÿé«˜ï¼Œå°±å¯ä»¥åœ¨è¿›å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—æ—¶æ’åœ¨å‰é¢ã€‚åœ¨ä¸‹ä¸€è½®å®ä»»åŠ¡é˜Ÿåˆ—éå†æ—¶ä¼˜å…ˆæ‰§è¡Œã€‚

## å†…å±‚å¾ªç¯ - workLoop

[workLoop](#workloop)å®é™…ä¸Šå°±æ˜¯åœ¨å¾ªç¯ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¼šé€šè¿‡ peek å–å‡ºå †é¡¶ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œå…¶ä¸­å­˜å‚¨çš„ callback å›è°ƒã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šcallback çš„æ‰§è¡Œä¹Ÿå¯èƒ½ä¼šè¢«ä¸­æ–­ï¼Œåªæ‰§è¡Œäº†ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä»–ä¼šæŠŠå‰©ä¸‹çš„ä»»åŠ¡è®°å½•ä¸‹æ¥å¹¶è¿”å›ï¼Œé‡æ–°å…¥é˜Ÿï¼Œç­‰å¾…åœ¨ä¸€ä¸‹è½®äº‹ä»¶å¾ªç¯ä¸­ç»§ç»­æ‰§è¡Œã€‚

callback å•ä»»åŠ¡å†…éƒ¨å®é™…ä¸Šå°±æ˜¯ fiber é“¾è¡¨ çš„å¾ªç¯ã€‚

## æ€»ç»“

æ•´ä¸ªæ—¶é—´åˆ‡ç‰‡çš„å®ç°åŸç†ï¼Œæˆ‘ä»¬è¦ç»“åˆæµè§ˆå™¨çš„äº‹ä»¶å¾ªç¯æœºåˆ¶æ‰èƒ½å®Œæ•´çš„æ¶ˆåŒ–è¿™ä¸€éƒ¨åˆ†é€»è¾‘ã€‚åœ¨æºç é€»è¾‘ä¸Šä¸€å…±æœ‰ä¸‰å±‚å¾ªç¯ï¼Œå¤–å±‚çš„é€’å½’å¾ªç¯ï¼Œå†…å±‚çš„ taskQueue workLoopï¼Œä»¥åŠå•ä¸ªä»»åŠ¡çš„ FiberTree workLoopConcurrentã€‚

# ä¼˜å…ˆçº§

å­˜åœ¨å¤šä¸ªä¼˜å…ˆçº§ï¼Œä¸”å­˜åœ¨è½¬æ¢å…³ç³»ã€‚

```
Lane -> EventPriority -> PriorityLevel -> expirationTime -> sortIndex

Laneã€EventPriority éƒ½æ˜¯ LaneLevel
expirationTimeã€sortIndex éƒ½æ˜¯ TimerLevel
```

## PriorityLevel

```js
export type PriorityLevel = 0 | 1 | 2 | 3 | 4 | 5;

// TODO: Use symbols?
export const NoPriority = 0;
// ç«‹å³æ‰§è¡Œï¼Œä¼˜å…ˆçº§æå‰ã€å¯ç”¨äºæ¨¡æ‹Ÿå¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœº
export const ImmediatePriority = 1;
// é€šå¸¸æŒ‡è¾“å…¥ã€ç”¨æˆ·ç‚¹å‡»ç­‰å½±å“ç”¨æˆ·ä½“éªŒçš„å“åº”äº‹ä»¶è§¦å‘çš„æ›´æ–°ï¼Œä¼˜å…ˆçº§è¾ƒé«˜
export const UserBlockingPriority = 2;
// æ™®é€šæ›´æ–°ä¼˜å…ˆçº§ï¼Œå¤§å¤šæ•°çš„çŠ¶æ€æ›´æ–°éƒ½æ˜¯è¿™ä¸ªçº§åˆ«
export const NormalPriority = 3;
// ä½ä¼˜å…ˆçº§
export const LowPriority = 4;
// ç©ºé—²ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼ŒstartTransition ä¼šä½¿ç”¨è¿™ä¸ªä¼˜å…ˆçº§
export const IdlePriority = 5;
```

åŸºæœ¬ä¼šåœ¨å…¥é˜Ÿ[scheduleCallback](#schedulecallback)çš„æ—¶å€™è·Ÿéšä»»åŠ¡ä¸€èµ·ä¼ é€’ã€‚

```js
// useEffect çš„æ›´æ–°
scheduleCallback(NormalSchedulerPriority, () => {
  flushPassiveEffects(true);
  // This render triggered passive effects: release the root cache pool
  // *after* passive effects fire to avoid freeing a cache pool that may
  // be referenced by a node in the tree (HostRoot, Cache boundary etc)
  return null;
});

// startTransition
if (prevPendingTransitionCallbacks !== null) {
  currentPendingTransitionCallbacks = null;
  scheduleCallback(IdleSchedulerPriority, () => {
    processTransitionCallbacks(
      prevPendingTransitionCallbacks,
      endTime,
      prevRootTransitionCallbacks,
    );
  });
}
```

## TimerLevel

åœ¨å…¥é˜Ÿçš„æ—¶å€™ï¼Œä¼šæ ¹æ®ä¼˜å…ˆçº§å»å›ºå®šæ¨ç®—è¿‡æœŸæ—¶é—´ã€ŒexpirationTimeã€ï¼Œç„¶åé˜Ÿåˆ—ä¼šæ ¹æ®è¿™ä¸ªå­—æ®µè¿›è¡Œæ’åºã€‚

```js
var expirationTime = startTime + timeout;

/* é¡¶å †ä¸­çš„æ’åºå‡½æ•° */
function compare(a: Node, b: Node) {
  /* sortIndex == expirationTime */
  const diff = a.sortIndex - b.sortIndex;
  return diff !== 0 ? diff : a.id - b.id;
}
```

> æ‰€ä»¥éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¼˜å…ˆçº§é«˜çš„ !== å…ˆæ‰§è¡Œ
>
> æœ€ç»ˆä»»åŠ¡é˜Ÿåˆ—è¿˜æ˜¯æ ¹æ® expirationTime è¿›è¡Œæ’åºçš„ï¼Œç„¶è€Œ expirationTime è¿˜æœ‰ä¸€ä¸ªå› ç´ æ˜¯ startTimeï¼Œä¹Ÿå°±æ˜¯å…¥é˜Ÿçš„æ—¶é—´ã€‚
>
> å› æ­¤ï¼Œè¿›å…¥é˜Ÿåˆ—å¾—è¶Šæ—©ï¼Œé‚£ä¹ˆæ‰§è¡Œçš„ä¼˜å…ˆçº§ä¹Ÿä¼šè¶Šé«˜ã€‚

## LaneLevel

Lane ä¸“é—¨ç”¨æ¥ç®¡ç† Fiber èŠ‚ç‚¹çš„ä¼˜å…ˆçº§ã€‚Fiber èŠ‚ç‚¹ä»»åŠ¡æ¯”è¾ƒç»†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æœºåˆ¶æ¥ç®¡ç†è¿™äº›ç»†ç²’åº¦çš„ä¼˜å…ˆçº§ã€‚

åœ¨è°ƒç”¨ scheduleCallback å‰ä¼šé€šè¿‡ scheduleTaskForRootDuringMicrotask å°† lane è½¬ä¸º PriorityLevelã€‚

scheduleTaskForRootDuringMicrotask -> scheduleCallback

```js
// è½¬æ¢ä¼˜å…ˆçº§
function scheduleTaskForRootDuringMicrotask(
  root: FiberRoot,
  currentTime: number,
): Lane {
  ...
  const nextLanes = getNextLanes(
    root,
    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes,
  );

  let schedulerPriorityLevel;
  switch (lanesToEventPriority(nextLanes)) {
    case DiscreteEventPriority:
      schedulerPriorityLevel = ImmediateSchedulerPriority;
      break;
    case ContinuousEventPriority:
      schedulerPriorityLevel = UserBlockingSchedulerPriority;
      break;
    case DefaultEventPriority:
      schedulerPriorityLevel = NormalSchedulerPriority;
      break;
    case IdleEventPriority:
      schedulerPriorityLevel = IdleSchedulerPriority;
      break;
    default:
      schedulerPriorityLevel = NormalSchedulerPriority;
      break;
  }

  const newCallbackNode = scheduleCallback(
    schedulerPriorityLevel,
    performWorkOnRootViaSchedulerTask.bind(null, root),
  );

  root.callbackPriority = newCallbackPriority;
  root.callbackNode = newCallbackNode;
  return newCallbackPriority;
}
```

ä¸ºäº†æ›´å¿«çš„è¿ç®—é€Ÿåº¦ï¼ŒReact åº•å±‚åŸºäº 31 ä½äºŒè¿›åˆ¶çš„ä½è¿ç®—æ¥è®¾è®¡ Lane çš„ä¼˜å…ˆçº§æ¨¡å‹ã€‚

**é€šè¿‡ |ã€ŒæŒ‰ä½æˆ–-åˆå¹¶ã€ã€&ã€ŒæŒ‰ä½ä¸-æ£€æŸ¥ã€ã€~ã€ŒæŒ‰ä½å-åˆ é™¤ã€æ¥å®ç°ä¼˜å…ˆçº§çš„æ“ä½œã€‚**

# fiber

fiber æ˜¯ React çš„å·¥ä½œå•å…ƒï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ fiber èŠ‚ç‚¹ã€‚

åœ¨ fiber ä¹‹å‰ï¼Œreact ä¸­å­˜åœ¨ä¸‰ç§èŠ‚ç‚¹å¯¹è±¡ã€‚

1. VisualDom
2. ReactElement
3. fiber

jsx -> ReactElementã€Œé™æ€èŠ‚ç‚¹ã€ -> fiberã€ŒåŒ…å«åŠ¨æ€å†…å®¹ï¼Œå­˜å‚¨çŠ¶æ€ã€æ›´æ–°ã€é“¾è¡¨ã€ -> VisualDom

## fiber-tree æ„å»º

fiber tree åœ¨æ„å»ºçš„è¿‡ç¨‹ä¸­ã€Œæ·±åº¦ä¼˜å…ˆéå†ã€ï¼Œä¼šäº¤æ›¿æ‰§è¡Œ beginWorkã€completeWorkã€‚

fiber æ ‘æ„é€ å¾ªç¯è´Ÿè´£æ„é€ æ–°çš„ fiber æ ‘, æ„é€ è¿‡ç¨‹ä¸­åŒæ—¶æ ‡è®° fiber.flags, æœ€ç»ˆæŠŠæ‰€æœ‰è¢«æ ‡è®°çš„ fiber èŠ‚ç‚¹æ”¶é›†åˆ°ä¸€ä¸ªå‰¯ä½œç”¨é˜Ÿåˆ—ä¸­, è¿™ä¸ªå‰¯ä½œç”¨é˜Ÿåˆ—è¢«æŒ‚è½½åˆ°æ ¹èŠ‚ç‚¹ä¸Š (rootFiber.alternate.firstEffect). æ­¤æ—¶çš„ fiber æ ‘å’Œä¸ä¹‹å¯¹åº”çš„ DOM èŠ‚ç‚¹éƒ½è¿˜åœ¨å†…å­˜å½“ä¸­, ç­‰å¾… commitRoot é˜¶æ®µè¿›è¡Œæ¸²æŸ“ã€‚

![alt text](https://cdn.jsdelivr.net/gh/akira1ce/blog-images@main/20250614191852329.png)

## executionContext

ç”¨äºæè¿°å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚æ‰§è¡Œä¸Šä¸‹æ–‡ä¼šè®°å½•å½“å‰çš„ä»»åŠ¡æ‰§è¡Œé˜¶æ®µï¼Œä¾‹å¦‚æ˜¯å¦å¤„äºæ¸²æŸ“é˜¶æ®µã€‚

```js
/* ReactFiberWorkLoop.js */

type ExecutionContext = number;

// æ²¡æœ‰ä¸Šä¸‹æ–‡
export const NoContext = /*             */ 0b000;
// æ‰¹å¤„ç†é˜¶æ®µ
const BatchedContext = /*               */ 0b001;
// æ¸²æŸ“é˜¶æ®µ
export const RenderContext = /*         */ 0b010;
// æäº¤é˜¶æ®µ
export const CommitContext = /*         */ 0b100;

// Describes where we are in the React execution stack
let executionContext: ExecutionContext = NoContext;


// åœ¨å…¶ä»–æ¨¡å—è·å–å½“å‰ä¸Šä¸‹æ–‡
export function getExecutionContext(): ExecutionContext {
  return executionContext;
}
```

ä¾‹å¦‚åœ¨ `scheduleImmediateTask` ä¸­å°±ä¼šå–è¯¥çŠ¶æ€åˆ¤æ–­ï¼Œå¤„äº**æ¸²æŸ“æˆ–æäº¤**é˜¶æ®µï¼Œåˆ™è§¦å‘ä»»åŠ¡é˜Ÿåˆ—å…¥é˜Ÿï¼Œå¹¶æ ‡è®°é«˜ä¼˜å…ˆçº§ã€‚

## lanes

ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œåœ¨ react ä¸­å­˜åœ¨ä¸‰ç§ lanesã€‚

1. update.lanes - è¡¨ç¤ºå½“å‰ update çš„ä¼˜å…ˆçº§é€šé“ï¼ˆlaneï¼‰
2. fiber.lanes - è¡¨ç¤ºè¯¥ fiberï¼ˆèŠ‚ç‚¹ï¼‰ä¸ŠæŒ‚è½½äº†å“ªäº›ä¼˜å…ˆçº§çš„æ›´æ–°
3. render.lens - å½“å‰ä¸€æ¬¡ render ä½¿ç”¨çš„ lanesï¼ˆä¼˜å…ˆçº§é€šé“é›†åˆï¼‰

update æ˜¯ä¸€ä¸ªæŒ‚è½½åœ¨ fiber.updateQueue ä¸Šçš„æ›´æ–°å¯¹è±¡ï¼Œè®°å½•äº† setState çš„ action å†…å®¹ã€ä¼˜å…ˆçº§ç­‰ã€‚

**ä¸‰è€…å…³ç³»:**

```
  setState() è§¦å‘
          â”‚
          â–¼
  ç”Ÿæˆ update.lane
          â”‚
          â–¼
  update æŒ‚è½½åˆ° fiber.updateQueue
          â”‚
          â–¼
  fiber.lanes |= update.lane
          â”‚
          â–¼
  markUpdateLaneFromFiberToRoot()
          â”‚
          â–¼
  root.pendingLanes |= update.lane
          â”‚
          â–¼
  â†“ è°ƒåº¦ â†“ è¿›å…¥ render
          â”‚
          â–¼
  renderLanes = getNextLanes()
```

update.lanes --åˆå¹¶-> fiber.lanes --åˆå¹¶-> root.paddingLanes

åœ¨æ¸²æŸ“æ—¶ï¼Œåªå¤„ç† fiber.lanes & renderLanes çš„èŠ‚ç‚¹ã€‚

## diff

**diff ä¸­çš„ä¸€æ®µé€»è¾‘**

1. props æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
2. context æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
3. ç»§ç»­åˆ¤æ–­æ˜¯å¦æœ‰æŒ‚èµ·çš„ update æˆ–è€… context
4. ç»§ç»­åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•è·åˆ°çš„é”™è¯¯æ ‡è®°

è¿™äº›éƒ½æ²¡æœ‰å‘ç”Ÿä¹‹åï¼Œæ‰ä¼šæœ€ç»ˆå†³å®šå¤ç”¨èŠ‚ç‚¹ï¼Œå¦åˆ™å°±ä¼šé‡æ–°åˆ›å»ºèŠ‚ç‚¹ã€‚

## context ä¼˜åŒ– -ã€ŒReact-19ã€

React çš„ Context æ˜¯ä¸€ç§ç”¨äºè·¨ç»„ä»¶æ ‘ä¼ é€’æ•°æ®çš„æœºåˆ¶ã€‚å½“ä¸€ä¸ª Context çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒReact ä¼šé€šçŸ¥æ‰€æœ‰è®¢é˜…äº†è¯¥ Context çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚ç„¶è€Œï¼Œè¿™ç§æœºåˆ¶åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼š

ä¸å¿…è¦çš„æ¸²æŸ“ï¼šå³ä½¿æŸä¸ªç»„ä»¶å¹¶ä¸ç›´æ¥ä½¿ç”¨ Context çš„å€¼ï¼Œåªè¦å®ƒçš„çˆ¶ç»„ä»¶è®¢é˜…äº† Contextï¼Œå®ƒä¹Ÿä¼šè¢«é‡æ–°æ¸²æŸ“ã€‚

é«˜é¢‘æ›´æ–°ï¼šå¦‚æœ Context çš„å€¼é¢‘ç¹å˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œå½±å“æ€§èƒ½ã€‚

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒReact å¼•å…¥äº† æ‡’ä¼ æ’­æœºåˆ¶ã€‚

**Lazy Context Propagation**

**æ‡’ä¼ æ’­**çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåªæœ‰å½“ç»„ä»¶çœŸæ­£ä½¿ç”¨äº† Context çš„å€¼æ—¶ï¼Œæ‰é€šçŸ¥å®ƒé‡æ–°æ¸²æŸ“ã€‚è¿™æ ·å¯ä»¥é¿å…ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œæé«˜æ€§èƒ½ã€‚

- ä¼˜åŒ– Context çš„æ€§èƒ½ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“ã€‚
- åœ¨å¹¶å‘æ¨¡å¼ä¸‹æ›´å¥½åœ°æ”¯æŒé«˜é¢‘æ›´æ–°å’Œå¤æ‚ä¾èµ–å…³ç³»ã€‚
- æä¾›æ›´ç»†ç²’åº¦çš„æ›´æ–°æ§åˆ¶

# hook

## class ç»„ä»¶å­˜åœ¨çš„é—®é¢˜

ç±»ç»„ä»¶çš„å¼€å‘æ–¹å¼éå¸¸ç›´è§‚å’Œæ˜“äºç†è§£ã€‚

ä½†çŠ¶æ€å’Œç»„ä»¶æ˜¯ç´§å¯†è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œéœ€è¦å¤ç”¨æŸä¸€æ®µé€»è¾‘çš„æ—¶å€™å°±å¾ˆå¤æ‚ï¼Œå¾—é€šè¿‡**é«˜é˜¶ç»„ä»¶**çš„æ–¹å¼å»åšã€‚

ç„¶è€Œ class é«˜é˜¶ç»„ä»¶ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ï¼š

1. **ä»£ç å†—ä½™ä¸ç®€æ´ï¼Œå¯è¯»æ€§ä½**
2. **è¿œè¶…é¢„æœŸçš„ç»„ä»¶åµŒå¥—å±‚çº§**
3. **å¤ç”¨å¤šæ®µçŠ¶æ€é€»è¾‘æ—¶ï¼Œæ— æ³•åœ¨ç»„ä»¶ä¸­åŒºåˆ†æ¥æºï¼Œå¹¶ä¸”åŒåçš„çŠ¶æ€ä¼šå†²çª**

## hook & é—­åŒ…

æ‰€æœ‰ hook éƒ½æœ‰ä¸€äº›ç‰¹æ€§ï¼šæ•°æ®ç¼“å­˜ã€‚

å®é™…æ˜¯ç»„ä»¶æœ¬èº«ä¹Ÿå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ react åº•å±‚ç»„ä»¶å‡½æ•°å¤–å±‚å®é™…è¿˜ä¼šå¥—å‡½æ•°ã€‚

é‚£ä¹ˆè¦ç¼“å­˜å‡½æ•°å†…éƒ¨çš„çŠ¶æ€ï¼Œæœ€ä½³çš„é€”å¾„å°±æ˜¯ **é—­åŒ…**ã€‚

fiber ä¸ hook ä¹‹é—´ï¼Œæ—¢è¦èƒ½å¤Ÿå„è‡ªç‹¬ç«‹ï¼Œåˆè¦èƒ½å¤Ÿç›¸äº’å…³è”ã€‚è€Œè¦åšåˆ°è¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨**é—­åŒ…**æ¥å®ç°ã€‚

`Comp -> fiber -> fiber.memoizedState`

æ¯ä¸ªç»„ä»¶çš„ hook æ˜¯é€šè¿‡é“¾è¡¨çš„å½¢å¼å­˜å‚¨åœ¨ **fiber.memoizedState** ä¸Šçš„ã€‚

## Hook & fiber

ç»„ä»¶å‡½æ•°åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ hookï¼Œä¾‹å¦‚ useStateã€‚æ­¤æ—¶ä¼šåˆ›å»º hook å¯¹è±¡ï¼Œå¹¶æŒ‚åœ¨åˆ° fiber å®ä¾‹ä¸Šã€‚

> æ‰§è¡Œç»„ä»¶å‡½æ•°ã€ŒComponentã€å‘ç”Ÿåœ¨ï¼š
>
> beginWork -> updateFunctionComponent -> renderWithWork -> Component()

Hook çš„ç±»å‹å®šä¹‰ï¼š

```ts
// ã€Œstate-hookã€
export type Hook = {
  // å½“å‰ hook çš„çŠ¶æ€å€¼
  memoizedState: any,
  // åŸºå‡†å€¼ - æ¯æ¬¡ update çš„åŸºå‡†
  baseState: any,
  // å­˜å‚¨ é«˜äºæœ¬æ¬¡æ¸²æŸ“çš„ update ç¯å½¢é“¾è¡¨
  baseQueue: Update<any, any> | null,
  // update å¾ªç¯é“¾è¡¨
  queue: any,
  // æŒ‡å‘ä¸‹ä¸€ä¸ª hook
  next: Hook | null,
};

// ã€Œeffect-hookã€
type EffectInstance = {
  destroy: void | (() => void),
};

export type Effect = {
  // effect ç±»å‹
  tag: HookFlags,
  // å‰¯ä½œç”¨å›è°ƒ
  create: () => (() => void) | void,
  // å‰¯ä½œç”¨æ¸…ç†å‡½æ•°
  inst: EffectInstance,
  // ä¾èµ–é¡¹
  deps: Array<mixed> | null,
  // æŒ‡å‘ä¸‹ä¸€ä¸ª effect
  next: Effect,
};
```

![img](https://cdn.jsdelivr.net/gh/akira1ce/blog-images@main/20250614191902004.jpg)

```
renderWithHooks
  â”œâ”€â”€ mountState / updateStateï¼ˆæ„é€  useStateï¼‰
  â”œâ”€â”€ mountEffect / updateEffectï¼ˆæ„é€  useEffectï¼‰
  â””â”€â”€ æ„å»º Hook é“¾è¡¨ï¼ˆmemoizedState å•å‘ + effect ç¯å½¢ï¼‰

setState / dispatch
  â””â”€â”€ æ·»åŠ  update åˆ° pending ç¯å½¢é“¾è¡¨ï¼Œè°ƒåº¦æ›´æ–°

commitRoot
  â””â”€â”€ éå† updateQueue.lastEffectï¼ˆeffect ç¯å½¢é“¾è¡¨ï¼‰ï¼Œæ‰§è¡Œå‰¯ä½œç”¨
```

## åç»­...

# Diff æ¶æ„

## React æ›´æ–°æœºåˆ¶

ä¸»æµæ•°æ®é©±åŠ¨ UI æ–¹æ¡ˆï¼š

1. é¢—ç²’åº¦æ›´æ–° - æ•°æ®åŠ«æŒ
2. å…¨é‡æ›´æ–°

> æ‰€æœ‰çš„äº‹æƒ…éƒ½æ˜¯å¯¹ç­‰çš„ã€‚

**é¢—ç²’åº¦æ›´æ–°**ï¼Œèƒ½å¿«é€Ÿçš„åœ¨æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä»¥æœ€å°çš„ä»£ä»·æ›´æ–° domï¼Œä»£ä»·å°±æ˜¯åœ¨åˆæœŸéœ€è¦é€šè¿‡**Proxy**åšæ•°æ®åŠ«æŒï¼Œå°†**æ•°æ®**ä¸**è§†å›¾**ç»‘å®šï¼Œè¿™ä¸€è¿‡ç¨‹å¿…ç„¶æ˜¯é¢å¤–è€—æ—¶çš„ã€‚é‡åˆ°è¶Šå¤æ‚åµŒå¥—çš„æ•°æ®ç»“æ„ï¼ŒåŠ«æŒçš„è¿‡ç¨‹å°±ä¼šè¶Šå¤æ‚ã€‚

**å…¨é‡æ›´æ–°**ï¼Œåˆ™æ˜¯è‡ªé¡¶å‘ä¸‹ï¼Œå°†é¡µé¢æ‰€æœ‰çš„å‡½æ•°å…¨éƒ¨æ‰§è¡Œä¸€éï¼Œå½“ç„¶åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­æœ‰ diff ç®—æ³•çš„ä¼˜åŒ–ã€‚

å…¨é‡æ›´æ–°çš„ä¼˜åŠ¿ï¼š

1. æ•°æ®å¹²å‡€ï¼Œä¸éœ€è¦é¢å¤–çš„å¤„ç†ï¼Œåœ¨å¤æ‚æ•°æ®çš„å¤„ç†åœºæ™¯ä¸‹æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿
2. ç¬¦åˆå‡½æ•°å¼çš„ç¼–ç¨‹æ€æƒ³ï¼Œåœ¨**ä»£ç çš„å¼€å‘ä½“éªŒã€æ‰§è¡Œçš„å¯é¢„æµ‹æ€§**ä¸Šæœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚å› æ­¤ï¼ŒReact ç»„ä»¶æ›´å®¹æ˜“è¢«æµ‹è¯•ï¼Œåœ¨å¯ç»´æŠ¤æ€§ä¸Šæœ‰æ˜æ˜¾çš„ä¼˜åŠ¿

ç¼ºç‚¹å°±æ˜¯ä¸èƒ½å…¨é  diff ç®—æ³•åšåˆ°é«˜æ•ˆçš„é¢—ç²’åº¦æ›´æ–°ï¼Œæ›´å¤šçš„éœ€è¦å¼€å‘è€…è‡ªè¡Œé…åˆã€‚

## diff ç­–ç•¥

æ ¸å¿ƒç­–ç•¥ï¼š**åŒå±‚æ¯”è¾ƒ**

dom èŠ‚ç‚¹ä¸­**ç§»åŠ¨**çš„æƒ…å†µæ˜¯å¾ˆéš¾å»æŠŠæ§çš„ï¼Œæ¯”å¦‚è¯´æŸä¸€ä¸ªèŠ‚ç‚¹åŠ åˆ°æŸä¸ªèŠ‚ç‚¹ä¸‹é¢ï¼Œä½œä¸ºå­èŠ‚ç‚¹ï¼Œé‚£åˆ°åº•æ˜¯ç§»åŠ¨ã€è¿˜æ˜¯åˆ›å»ºäº†çˆ¶èŠ‚ç‚¹ï¼Œå¾ˆéš¾å»åˆ¤å®šã€‚

å› æ­¤ï¼Œreact ä¸­æ”¾å¼ƒäº†ç§»åŠ¨çš„æƒ…å†µï¼Œé‡‡ç”¨äº†**åŒå±‚æ¯”è¾ƒ**ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯åˆ—è¡¨èŠ‚ç‚¹è¿˜æ˜¯ä¼šè€ƒè™‘ç§»åŠ¨çš„æƒ…å†µçš„ã€‚
>
> å› ä¸ºæ•´ä¸ªåˆ—è¡¨é‡æ–°æ„å»ºå¯èƒ½å­˜åœ¨æ›´å¤§çš„å†…å­˜æ¶ˆè€—ï¼Œç›¸å¯¹äºç§»åŠ¨æ¥è¯´ï¼Œå¹¶ä¸”åˆ—è¡¨ä¸­çš„ç§»åŠ¨ç›¸å¯¹æ¥è¯´æ˜¯å¾ˆå¥½åˆ¤æ–­ã€‚

![1](https://cdn.jsdelivr.net/gh/akira1ce/blog-images@main/20250614191911523.png)

**èŠ‚ç‚¹å¤ç”¨**

æ ¸å¿ƒæ˜¯é€šè¿‡ **didReceiveUpdateã€Œå…¨å±€å˜é‡ã€** æ¥æ ‡è®°å½“å‰èŠ‚ç‚¹æ˜¯å¦èƒ½å¤Ÿå¤ç”¨ã€‚

1. props
2. context
3. é€šè¿‡ä¼˜å…ˆçº§åˆ¤æ–­æ˜¯å¦ç¬¦åˆå¤ç”¨æ¡ä»¶
4. state

## èŠ‚ç‚¹æ¯”è¾ƒ

`workLoopConcurrent -> performUnitOfWork -> beginWork`

beginWork ä¸­åˆ™æ˜¯æ ¹æ® props/context/state å»å˜æ›´ didReceiveUpdate çš„å€¼ï¼Œæ¥ç¡®å®šå­èŠ‚ç‚¹æ˜¯å¦å¯ä»¥å¤ç”¨ã€‚

> workLoopConcurrent ä¼ å…¥çš„ workInProcess æ˜¯å½“å‰å·¥ä½œä¸­çš„æ ¹èŠ‚ç‚¹ï¼Œå› æ­¤å®é™…ä¸Šæ¯è½®æ¯”è¾ƒçš„èŠ‚ç‚¹æ˜¯å­èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯å½“å‰èŠ‚ç‚¹ã€‚

å½“å‰ fiber èŠ‚ç‚¹ç¡®å®šæ— æ³•å¤ç”¨åï¼Œä¼šé€šè¿‡ **reconcileChildFibers** è¿›ä¸€æ­¥åˆ¤æ–­å­èŠ‚ç‚¹æ˜¯å¦èƒ½å¤Ÿå¤ç”¨ã€‚

å› ä¸ºä¸€æ—¦ fiber èŠ‚ç‚¹ä¸å¯å¤ç”¨ï¼Œreact ä¼šå°†å…¶åŒ…æ‹¬å…¶å­èŠ‚ç‚¹å…¨éƒ¨é‡æ–°æ„å»ºï¼Œæ­¤æ—¶å°±éœ€è¦å°½å¯èƒ½çš„å¤ç”¨å…¶å­èŠ‚ç‚¹ã€‚

å…¶å†…éƒ¨ä¼šæ ¹æ®èŠ‚ç‚¹ç±»å‹è°ƒç”¨ä¸€ä¸‹å‡½æ•°ï¼š

```js
function reconcileSingleElement() {...}
function reconcileSingleTextNode() {...}
function reconcileChildrenIterator() {...}
function reconcileChildrenIteratable() {...}
function reconcileSinglePortal() {...}
function reconcileChildrenArray() {...}
```

## åˆ—è¡¨èŠ‚ç‚¹

ç›¸å¯¹äºåŸæ¥èŠ‚ç‚¹ä½ç½®ç§»åŠ¨åˆ°åé¢çš„æ—¶å€™ï¼Œæ‰ä¼šç§»åŠ¨èŠ‚ç‚¹ã€‚

> è¿™é‡Œè¯´çš„ç§»åŠ¨ï¼ŒæŒ‡çš„æ˜¯å¯¹çœŸå® dom çš„æ“ä½œã€‚

```js
æ—§åˆ—è¡¨ï¼š[A] [B] [C] [D]
æ–°åˆ—è¡¨ï¼š[B] [A] [D] [C]

[B] ä¸ç§»åŠ¨
[A] ç›¸å¯¹åç§»äº†ï¼Œç§»åŠ¨
[C] ç›¸å¯¹åç§»äº†ï¼Œç§»åŠ¨
[D]ä¸ç§»åŠ¨
```

# äº‹ä»¶ç³»ç»Ÿ

JSX ä¸æ˜¯çœŸå®çš„ DOMï¼Œå› æ­¤ä¸Šé¢çš„äº‹ä»¶ä¹Ÿä¸æ˜¯ç›´æ¥ DOM ä¸Šçš„åŸç”Ÿè§¦å‘çš„äº‹ä»¶ã€‚

React å¹¶ä¸ä¼šä¸ºæ¯ä¸ªç»„ä»¶æˆ– DOM èŠ‚ç‚¹éƒ½ç»‘å®šäº‹ä»¶ã€‚

React ä¸­æ˜¯é€šè¿‡ **ç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å™¨** æŒ‚åœ¨æ ¹èŠ‚ç‚¹ä¸Šï¼Œç„¶ååœ¨äº‹ä»¶è§¦å‘æ—¶ï¼Œä½¿ç”¨ä¸€å¥—è‡ªå·±çš„â€œåˆæˆäº‹ä»¶ç³»ç»Ÿâ€è¿›è¡Œå¤„ç†ã€‚

åœ¨ fiber-tree æ„å»ºçš„æ—¶å€™ï¼Œäº‹ä»¶å›è°ƒå­˜å‚¨åœ¨ fiber èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”å°†äº‹ä»¶æ³¨å†Œåœ¨æ ¹èŠ‚ç‚¹ä¸Šã€‚

dom è§¦å‘äº‹ä»¶çš„æ—¶å€™ï¼Œæ ¹æ® target æ‰¾åˆ°å¯¹åº”çš„ fiberï¼Œå¹¶ä¸”å‘ä¸Šå†’æ³¡ï¼Œæ‰§è¡Œäº‹ä»¶å›è°ƒã€‚

> æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œreact è‡ªå·±åˆæˆäº†**äº‹ä»¶å¯¹è±¡**ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸å›è°ƒæ¥æ”¶çš„å‚æ•° eventã€‚
>
> é€šè¿‡åˆæˆæ¥å®ç°è·¨æµè§ˆå™¨å…¼å®¹ã€æ€§èƒ½ä¼˜åŒ–å’Œç»Ÿä¸€çš„äº‹ä»¶ç®¡ç†ã€‚

```js
JSX ä¸­å†™ onClick
      â†“
Fiber æ„å»ºæ—¶å†™å…¥ memoizedProps
      â†“
é¦–æ¬¡æ¸²æŸ“æ³¨å†Œ document ä¸Šçš„ click äº‹ä»¶ç›‘å¬å™¨
      â†“
æµè§ˆå™¨åŸç”Ÿäº‹ä»¶å†’æ³¡åˆ° container
      â†“
React æ•è· â†’ æ‰¾åˆ°äº‹ä»¶ target å¯¹åº”çš„ Fiber èŠ‚ç‚¹
      â†“
æŸ¥æ‰¾å›è°ƒ â†’ å°è£… SyntheticEvent
      â†“
ä¾ç…§å†’æ³¡/æ•è·é˜¶æ®µé¡ºåºæ‰§è¡Œäº‹ä»¶å‡½æ•° - ã€Œä»å½“å‰èŠ‚ç‚¹å‘ä¸Šå¯»æ‰¾ç›¸åŒäº‹ä»¶ã€
```



# Sum

## ä¸ºä»€ä¹ˆ React å†…éƒ¨è¦è‡ªå®šä¹‰å¸§ï¼Œä¸ç›´æ¥ä½¿ç”¨æµè§ˆå™¨å·²ç»å­˜åœ¨çš„åˆ·æ–°ç‡å‘¢ï¼Ÿæˆ–è€…ä¼šé—®ä¸ºä»€ä¹ˆä¸ç›´æ¥åŸºäº requestIdleCallback æ¥å®ç°å‰©ä½™é€»è¾‘çš„æ‰§è¡Œï¼Ÿ

è¿™é‡Œæ ¸å¿ƒçš„åŸå› æ˜¯ä¸ºäº†å…¼é¡¾ä¸åŒå¹³å°çš„ç‰¹æ€§ã€‚åœ¨æµè§ˆå™¨ä¹‹å¤–çš„å…¶ä»–åœºæ™¯ï¼Œå¯èƒ½å¹¶ä¸æ”¯æŒåˆ·æ–°ç‡ç›¸å…³çš„äº‹ä»¶å›è°ƒã€‚

## React åŒæ­¥æ›´æ–°æ¨¡å¼ä¸å¼‚æ­¥æ›´æ–°æ¨¡å¼çš„åŒºåˆ«ï¼Ÿ

åŒæ­¥æ¨¡å¼ä¸­ï¼Œä¸ä¼šå¯¹ä»»åŠ¡è¿›è¡Œä¼˜å…ˆçº§çš„è®¾è®¡ä¸è°ƒåº¦ï¼Œæœ‰ä¸€ä¸ªä»»åŠ¡äº§ç”Ÿå°±ä¼šç›´æ¥æ‰§è¡Œï¼Œä¸ä¼šæŒ‰ç…§æ—¶é—´åˆ‡ç‰‡ä¸­æ–­ä»»åŠ¡çš„æ‰§è¡Œï¼Œå› æ­¤æœ‰é˜»å¡é¡µé¢æ¸²æŸ“çš„é£é™©ï¼Œå¯èƒ½ä¼šé€ æˆé¡µé¢å¡é¡¿ã€‚

## ä¸ºä»€ä¹ˆä¸èƒ½æŠŠ Hook å†™åœ¨æ¡ä»¶æ¸²æŸ“ä¸­ï¼Ÿ

ã€Œreact hook æ˜¯å­˜å‚¨åœ¨é“¾è¡¨çš„æ•°æ®ç»“æ„ä¸­çš„ï¼Œif æ¡ä»¶ä¼šå¯¼è‡´é“¾è¡¨èŠ‚ç‚¹ç¼ºå¤±ã€

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å‡½æ•°è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè®¿é—® hook æ˜¯é€šè¿‡ `current.memoizedState` è®¿é—®ï¼Œå…¶å¯¹åº”çš„æ˜¯ `hook` é“¾è¡¨ï¼Œç„¶åé€šè¿‡ `currentHook.next` æ¥è®¿é—®ä¸‹ä¸€ä¸ª hook

å¦‚æœæˆ‘ä»¬å°† `hook` æ”¾å…¥æ¡ä»¶åˆ¤æ–­ä¸­ï¼Œé‚£ä¹ˆåœ¨ä¸æ»¡è¶³æ¡ä»¶æ—¶ï¼Œè¯¥ `hook` å¯¹è±¡å°±ä¸ä¼šåœ¨é“¾è¡¨ä¸­å­˜åœ¨ï¼Œä»è€Œå¯¼è‡´ä¸¤æ¬¡è®¿é—®åˆ°çš„ hook ä¸ä¸€è‡´ï¼Œä»è€Œé€ æˆ**å–å€¼é”™è¯¯**

![img](https://cdn.jsdelivr.net/gh/akira1ce/blog-images@main/20250614191922253.jpg)

> [å®Œç»“ğŸ‰]
>
> å—ç›ŠåŒªæµ…ï¼Œä½†æœ‰äº›åœ°æ–¹ç†è§£ä¸æ˜¯å¾ˆé€å½»ï¼Œåç»­æœ‰ç©ºè¦é‡å¤´å†è¿‡è¿‡ã€‚
>
> åŸå†…å®¹æ¥è‡ªæ³¢ä½¬çš„[useHook-Reacté¢è¯•åŸç†](https://usehook.cn/reactprinciple)ï¼Œå¼ºçƒˆæ¨èè´­ä¹°é˜…è¯»ã€‚
